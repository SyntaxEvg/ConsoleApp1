–ü–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö –º–µ—Ç–æ–¥–æ–≤ - –≥–æ—Ç–æ–≤–∞—è –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é
–í—ã –ø—Ä–∞–≤—ã! –í–æ—Ç –≤—Å–µ –º–µ—Ç–æ–¥—ã —Ü–µ–ª–∏–∫–æ–º.

–§–∞–π–ª 1: /var/www/wp-content/plugins/adfs-sso-login/includes/adfs-auth.php
bashsudo nano /var/www/wp-content/plugins/adfs-sso-login/includes/adfs-auth.php
–ó–∞–º–µ–Ω–∏—Ç–µ –í–°–Å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ –Ω–∞:
php<?php

class ADFS_SSO_Auth {
    
    /**
     * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç URL –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ ADFS
     */
    public static function get_authorization_url() {
        $config = ADFS_SSO_Config::get_config();
        
        if (empty($config['authorize_url']) || empty($config['client_id']) || empty($config['redirect_uri'])) {
            error_log('ADFS: ‚ùå –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é!');
            return false;
        }
        
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º state –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç CSRF
        $state = wp_create_nonce('adfs_login_state');
        
        // –§–æ—Ä–º–∏—Ä—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞
        $params = array(
            'response_type' => 'code',
            'client_id'     => $config['client_id'],
            'redirect_uri'  => $config['redirect_uri'],
            'scope'         => 'openid profile email',
            'state'         => $state,
        );
        
        $auth_url = $config['authorize_url'] . '?' . http_build_query($params);
        
        error_log('ADFS: –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω URL –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ' . $auth_url);
        
        return $auth_url;
    }
    
    /**
     * –ü–æ–ª—É—á–∞–µ—Ç access token –ø–æ authorization code
     */
    public static function get_access_token($code) {
        $config = ADFS_SSO_Config::get_config();
        
        if (empty($config['token_url']) || empty($config['client_id']) || empty($config['client_secret'])) {
            error_log('ADFS: ‚ùå –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞!');
            return new WP_Error('adfs_config_error', 'ADFS –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω');
        }
        
        error_log('========================================');
        error_log('ADFS: –ü–û–õ–£–ß–ï–ù–ò–ï ACCESS TOKEN');
        error_log('========================================');
        error_log('ADFS: Token URL: ' . $config['token_url']);
        error_log('ADFS: Code (–ø–µ—Ä–≤—ã–µ 30): ' . substr($code, 0, 30) . '...');
        
        $body = array(
            'grant_type'    => 'authorization_code',
            'code'          => $code,
            'redirect_uri'  => $config['redirect_uri'],
            'client_id'     => $config['client_id'],
            'client_secret' => $config['client_secret'],
        );
        
        $body_log = $body;
        $body_log['client_secret'] = '***HIDDEN***';
        error_log('ADFS: –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞: ' . print_r($body_log, true));
        
        $args = array(
            'body'      => $body,
            'timeout'   => 30,
            'sslverify' => false,
            'headers'   => array(
                'Content-Type' => 'application/x-www-form-urlencoded',
            ),
        );
        
        error_log('ADFS: ‚è≥ –û—Ç–ø—Ä–∞–≤–ª—è—é POST –∑–∞–ø—Ä–æ—Å –Ω–∞ token endpoint...');
        
        $start_time = microtime(true);
        $response = wp_remote_post($config['token_url'], $args);
        $end_time = microtime(true);
        $duration = round(($end_time - $start_time) * 1000, 2);
        
        error_log('ADFS: ‚è±Ô∏è  –ó–∞–ø—Ä–æ—Å –≤—ã–ø–æ–ª–Ω–µ–Ω –∑–∞ ' . $duration . ' –º—Å');
        
        if (is_wp_error($response)) {
            error_log('ADFS: ‚ùå WP_Error –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ!');
            error_log('ADFS: Error code: ' . $response->get_error_code());
            error_log('ADFS: Error message: ' . $response->get_error_message());
            return $response;
        }
        
        $http_code = wp_remote_retrieve_response_code($response);
        $http_message = wp_remote_retrieve_response_message($response);
        $response_headers = wp_remote_retrieve_headers($response);
        $body_response = wp_remote_retrieve_body($response);
        
        error_log('ADFS: ========================================');
        error_log('ADFS: üì• –û–¢–í–ï–¢ –û–¢ ADFS TOKEN ENDPOINT');
        error_log('ADFS: ========================================');
        error_log('ADFS: HTTP Code: ' . $http_code);
        error_log('ADFS: HTTP Message: ' . $http_message);
        error_log('ADFS: ========================================');
        error_log('ADFS: üìÑ RAW RESPONSE BODY:');
        error_log($body_response);
        error_log('ADFS: ========================================');
        error_log('ADFS: –†–∞–∑–º–µ—Ä –æ—Ç–≤–µ—Ç–∞: ' . strlen($body_response) . ' –±–∞–π—Ç');
        
        if ($http_code !== 200) {
            error_log('ADFS: ‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π HTTP –∫–æ–¥: ' . $http_code);
            return new WP_Error(
                'adfs_token_http_error',
                'ADFS –≤–µ—Ä–Ω—É–ª –∫–æ–¥ ' . $http_code . ': ' . $body_response
            );
        }
        
        error_log('ADFS: üîç –ü–∞—Ä—Å–∏–Ω–≥ JSON...');
        $data = json_decode($body_response, true);
        
        if (json_last_error() !== JSON_ERROR_NONE) {
            error_log('ADFS: ‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON!');
            error_log('ADFS: JSON error: ' . json_last_error_msg());
            return new WP_Error('adfs_json_error', '–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON: ' . json_last_error_msg());
        }
        
        error_log('ADFS: ‚úì JSON —É—Å–ø–µ—à–Ω–æ —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω');
        error_log('ADFS: –ù–∞–π–¥–µ–Ω–Ω—ã–µ –∫–ª—é—á–∏: ' . implode(', ', array_keys($data)));
        
        if (empty($data['access_token'])) {
            error_log('ADFS: ‚ùå –í –æ—Ç–≤–µ—Ç–µ –Ω–µ—Ç access_token!');
            
            $error_msg = '–í –æ—Ç–≤–µ—Ç–µ ADFS –Ω–µ—Ç access_token';
            if (!empty($data['error'])) {
                $error_msg .= ': ' . $data['error'];
            }
            if (!empty($data['error_description'])) {
                $error_msg .= ' - ' . $data['error_description'];
            }
            
            return new WP_Error('adfs_no_token', $error_msg);
        }
        
        error_log('ADFS: ‚úì access_token –ø–æ–ª—É—á–µ–Ω!');
        
        // –ü–∞—Ä—Å–∏–º ID Token –µ—Å–ª–∏ –µ—Å—Ç—å
        if (!empty($data['id_token'])) {
            error_log('ADFS: ========================================');
            error_log('ADFS: üé´ –ü–ê–†–°–ò–ù–ì ID TOKEN');
            error_log('ADFS: ========================================');
            
            $id_parts = explode('.', $data['id_token']);
            
            if (count($id_parts) === 3) {
                $payload_base64 = strtr($id_parts[1], '-_', '+/');
                $payload_json = base64_decode($payload_base64);
                $id_payload = json_decode($payload_json, true);
                
                if ($id_payload && json_last_error() === JSON_ERROR_NONE) {
                    error_log('ADFS: ‚úì ID Token —É—Å–ø–µ—à–Ω–æ —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω!');
                    error_log('ADFS: –°–æ–¥–µ—Ä–∂–∏–º–æ–µ ID Token:');
                    error_log(print_r($id_payload, true));
                    
                    if (!empty($id_payload['email'])) {
                        error_log('ADFS: ‚úÖ Email –Ω–∞–π–¥–µ–Ω –≤ ID Token: ' . $id_payload['email']);
                    }
                    
                    if (!empty($id_payload['upn'])) {
                        error_log('ADFS: ‚úÖ UPN –Ω–∞–π–¥–µ–Ω –≤ ID Token: ' . $id_payload['upn']);
                    }
                    
                    $data['id_token_payload'] = $id_payload;
                    error_log('ADFS: ‚úì ID Token payload —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
                } else {
                    error_log('ADFS: ‚ùå –û—à–∏–±–∫–∞ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è ID Token: ' . json_last_error_msg());
                }
            } else {
                error_log('ADFS: ‚ùå ID Token –∏–º–µ–µ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç (—á–∞—Å—Ç–µ–π: ' . count($id_parts) . ')');
            }
            
            error_log('ADFS: ========================================');
        } else {
            error_log('ADFS: ‚ö†Ô∏è  ID Token –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –æ—Ç–≤–µ—Ç–µ');
        }
        
        error_log('ADFS: ========================================');
        error_log('ADFS: ‚úÖ get_access_token() –ó–ê–í–ï–†–®–Å–ù –£–°–ü–ï–®–ù–û');
        error_log('ADFS: ========================================');
        
        return $data;
    }
    
    /**
     * –ü–æ–ª—É—á–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ —á–µ—Ä–µ–∑ UserInfo endpoint
     */
    public static function get_user_info($access_token) {
        $config = ADFS_SSO_Config::get_config();
        
        if (empty($config['userinfo_url'])) {
            error_log('ADFS: UserInfo URL –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω');
            return new WP_Error('adfs_config_error', 'UserInfo URL –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω');
        }
        
        error_log('========================================');
        error_log('ADFS: –ó–ê–ü–†–û–° –ö USERINFO ENDPOINT');
        error_log('========================================');
        error_log('ADFS: URL: ' . $config['userinfo_url']);
        error_log('ADFS: Access Token (–ø–µ—Ä–≤—ã–µ 50): ' . substr($access_token, 0, 50) . '...');
        
        $args = array(
            'headers' => array(
                'Authorization' => 'Bearer ' . $access_token,
                'Accept'        => 'application/json',
            ),
            'timeout'   => 30,
            'sslverify' => false,
        );
        
        error_log('ADFS: –û—Ç–ø—Ä–∞–≤–ª—è—é GET –∑–∞–ø—Ä–æ—Å...');
        
        $response = wp_remote_get($config['userinfo_url'], $args);
        
        if (is_wp_error($response)) {
            error_log('ADFS: ‚ùå WP_Error: ' . $response->get_error_message());
            return $response;
        }
        
        $http_code = wp_remote_retrieve_response_code($response);
        $body = wp_remote_retrieve_body($response);
        
        error_log('ADFS: HTTP –∫–æ–¥: ' . $http_code);
        error_log('ADFS: RAW –æ—Ç–≤–µ—Ç –æ—Ç ADFS:');
        error_log($body);
        
        if ($http_code !== 200) {
            error_log('ADFS: ‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π HTTP –∫–æ–¥: ' . $http_code);
            return new WP_Error('adfs_userinfo_error', 'HTTP ' . $http_code . ': ' . $body);
        }
        
        $user_data = json_decode($body, true);
        
        if (json_last_error() !== JSON_ERROR_NONE) {
            error_log('ADFS: ‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON: ' . json_last_error_msg());
            return new WP_Error('adfs_json_error', 'JSON error: ' . json_last_error_msg());
        }
        
        error_log('ADFS: ‚úì JSON —É—Å–ø–µ—à–Ω–æ —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω');
        error_log('ADFS: –ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:');
        error_log(print_r($user_data, true));
        
        // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ - –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º –æ–±–∞ —Ñ–æ—Ä–º–∞—Ç–∞ claims
        $normalized = array(
            'sub' => $user_data['sub'] ?? null
        );
        
        // –ö–æ—Ä–æ—Ç–∫–∏–µ –∏–º–µ–Ω–∞ (OpenID Connect)
        if (isset($user_data['email'])) {
            $normalized['email'] = $user_data['email'];
        }
        if (isset($user_data['name'])) {
            $normalized['name'] = $user_data['name'];
        }
        if (isset($user_data['given_name'])) {
            $normalized['given_name'] = $user_data['given_name'];
        }
        if (isset($user_data['family_name'])) {
            $normalized['family_name'] = $user_data['family_name'];
        }
        if (isset($user_data['preferred_username'])) {
            $normalized['preferred_username'] = $user_data['preferred_username'];
        }
        if (isset($user_data['upn'])) {
            $normalized['upn'] = $user_data['upn'];
        }
        if (isset($user_data['unique_name'])) {
            $normalized['unique_name'] = $user_data['unique_name'];
        }
        
        // –ü–æ–ª–Ω—ã–µ URI (—Å—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç)
        if (empty($normalized['email']) && isset($user_data['http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress'])) {
            $normalized['email'] = $user_data['http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress'];
        }
        if (empty($normalized['name']) && isset($user_data['http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name'])) {
            $normalized['name'] = $user_data['http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name'];
        }
        if (empty($normalized['given_name']) && isset($user_data['http://schemas.xmlsoap.org/ws/2005/05/identity/claims/givenname'])) {
            $normalized['given_name'] = $user_data['http://schemas.xmlsoap.org/ws/2005/05/identity/claims/givenname'];
        }
        if (empty($normalized['family_name']) && isset($user_data['http://schemas.xmlsoap.org/ws/2005/05/identity/claims/surname'])) {
            $normalized['family_name'] = $user_data['http://schemas.xmlsoap.org/ws/2005/05/identity/claims/surname'];
        }
        if (empty($normalized['upn']) && isset($user_data['http://schemas.xmlsoap.org/ws/2005/05/identity/claims/upn'])) {
            $normalized['upn'] = $user_data['http://schemas.xmlsoap.org/ws/2005/05/identity/claims/upn'];
        }
        
        error_log('ADFS: –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:');
        error_log(print_r($normalized, true));
        error_log('========================================');
        
        return $normalized;
    }
}

–§–∞–π–ª 2: /var/www/wp-content/plugins/adfs-sso-login/adfs-sso-login.php
bashsudo nano /var/www/wp-content/plugins/adfs-sso-login/adfs-sso-login.php
–ù–∞–π–¥–∏—Ç–µ –∏ –∑–∞–º–µ–Ω–∏—Ç–µ –î–í–ê –º–µ—Ç–æ–¥–∞:
–ú–µ—Ç–æ–¥ 1: handle_adfs_callback() - –ü–û–õ–ù–ê–Ø –í–ï–†–°–ò–Ø
phppublic function handle_adfs_callback() {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –Ω–∞—à callback endpoint
    if (strpos($_SERVER['REQUEST_URI'], '/adfs-callback/') === false) {
        return;
    }
    
    error_log('========================================');
    error_log('ADFS: –ü–æ–ª—É—á–µ–Ω callback –æ—Ç ADFS');
    error_log('ADFS: REQUEST_URI: ' . $_SERVER['REQUEST_URI']);
    error_log('========================================');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–∫–∏ –æ—Ç ADFS
    if (isset($_GET['error'])) {
        $error_code = sanitize_text_field($_GET['error']);
        $error_description = isset($_GET['error_description']) ? sanitize_text_field($_GET['error_description']) : '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è';
        
        error_log('ADFS: ‚ùå –ü–æ–ª—É—á–µ–Ω–∞ –æ—à–∏–±–∫–∞ –æ—Ç ADFS: ' . $error_code);
        
        wp_die(
            '<div style="max-width: 800px; margin: 50px auto; padding: 30px; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">' .
            '<h1 style="color: #dc3545;">‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ ADFS</h1>' .
            '<div style="background: #f8d7da; padding: 15px; border-radius: 4px; margin: 20px 0;">' .
            '<p><strong>–ö–æ–¥:</strong> <code>' . esc_html($error_code) . '</code></p>' .
            '<p><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> ' . esc_html($error_description) . '</p>' .
            '</div>' .
            '<a href="' . wp_login_url() . '">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è</a>' .
            '</div>',
            '–û—à–∏–±–∫–∞ ADFS',
            array('response' => 400)
        );
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º code –∏ state
    if (!isset($_GET['code']) || !isset($_GET['state'])) {
        wp_die('–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã');
    }
    
    if (!wp_verify_nonce($_GET['state'], 'adfs_login_state')) {
        wp_die('–ù–µ–≤–µ—Ä–Ω—ã–π state –ø–∞—Ä–∞–º–µ—Ç—Ä');
    }
    
    $code = sanitize_text_field($_GET['code']);
    
    error_log('ADFS: Authorization code –ø–æ–ª—É—á–µ–Ω');
    
    // –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω
    $token_data = ADFS_SSO_Auth::get_access_token($code);
    
    if (is_wp_error($token_data)) {
        error_log('ADFS: ‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞!');
        wp_die(
            '<div style="max-width: 800px; margin: 50px auto; padding: 30px; background: white;">' .
            '<h1 style="color: #dc3545;">‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞</h1>' .
            '<p>' . esc_html($token_data->get_error_message()) . '</p>' .
            '<a href="' . wp_login_url() . '">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è</a>' .
            '</div>'
        );
    }
    
    error_log('ADFS: ‚úì Access token –ø–æ–ª—É—á–µ–Ω');
    
    // Debug mode –¥–ª—è –ø–æ–∫–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —ç–∫—Ä–∞–Ω–µ
    $debug_mode = defined('WP_DEBUG') && WP_DEBUG;
    
    if ($debug_mode && !empty($token_data['id_token_payload'])) {
        echo '<div style="max-width: 1200px; margin: 20px auto; padding: 20px; background: #f0f0f0; border: 2px solid #0073aa; border-radius: 8px; font-family: monospace; font-size: 12px;">';
        echo '<h2 style="color: #0073aa;">üé´ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ ID Token:</h2>';
        echo '<pre style="background: white; padding: 15px; border-radius: 4px; overflow: auto;">';
        print_r($token_data['id_token_payload']);
        echo '</pre>';
        echo '</div>';
        flush();
    }
    
    // –ü–†–ò–û–†–ò–¢–ï–¢ ID TOKEN
    error_log('ADFS: ========================================');
    error_log('ADFS: –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –ò–°–¢–û–ß–ù–ò–ö–ê –î–ê–ù–ù–´–•');
    error_log('ADFS: ========================================');
    
    $user_info = null;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º ID Token
    if (!empty($token_data['id_token_payload'])) {
        $id_payload = $token_data['id_token_payload'];
        
        error_log('ADFS: ‚úì –ù–∞–π–¥–µ–Ω ID Token payload');
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ email –∏–ª–∏ upn
        if (!empty($id_payload['email']) || !empty($id_payload['upn'])) {
            error_log('ADFS: üí° –ò–°–ü–û–õ–¨–ó–£–ï–ú –î–ê–ù–ù–´–ï –ò–ó ID TOKEN');
            
            // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ
            $user_info = array(
                'sub' => $id_payload['sub'] ?? null,
                'email' => $id_payload['email'] ?? $id_payload['upn'] ?? null,
                'name' => $id_payload['unique_name'] ?? $id_payload['name'] ?? null,
                'given_name' => $id_payload['given_name'] ?? null,
                'family_name' => $id_payload['family_name'] ?? null,
                'preferred_username' => $id_payload['preferred_username'] ?? $id_payload['upn'] ?? $id_payload['email'] ?? null,
                'upn' => $id_payload['upn'] ?? null,
            );
            
            error_log('ADFS: –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ ID Token:');
            error_log(print_r($user_info, true));
        }
    }
    
    // –ï—Å–ª–∏ ID Token –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã—Ö - –ø—Ä–æ–±—É–µ–º UserInfo
    if (empty($user_info) || empty($user_info['email'])) {
        error_log('ADFS: üîÑ –ó–∞–ø—Ä–∞—à–∏–≤–∞—é UserInfo endpoint');
        
        $userinfo_response = ADFS_SSO_Auth::get_user_info($token_data['access_token']);
        
        if (!is_wp_error($userinfo_response)) {
            if (!empty($user_info)) {
                $user_info = array_merge($user_info, array_filter($userinfo_response));
                error_log('ADFS: ‚úì –î–∞–Ω–Ω—ã–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω—ã –∏–∑ ID Token –∏ UserInfo');
            } else {
                $user_info = $userinfo_response;
                error_log('ADFS: ‚úì –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ UserInfo');
            }
        } else {
            // –ï—Å–ª–∏ UserInfo –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ ID Token –µ—Å—Ç—å - –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º
            if (!empty($user_info) && !empty($user_info['email'])) {
                error_log('ADFS: ‚ö†Ô∏è  UserInfo –æ—à–∏–±–∫–∞, –Ω–æ ID Token —Å–æ–¥–µ—Ä–∂–∏—Ç email - –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º');
            } else {
                error_log('ADFS: ‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –Ω–∏ –∏–∑ ID Token –Ω–∏ –∏–∑ UserInfo');
                wp_die(
                    '<div style="max-width: 800px; margin: 50px auto; padding: 30px; background: white;">' .
                    '<h1 style="color: #dc3545;">‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h1>' .
                    '<p>' . esc_html($userinfo_response->get_error_message()) . '</p>' .
                    '<a href="' . wp_login_url() . '">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è</a>' .
                    '</div>'
                );
            }
        }
    }
    
    error_log('ADFS: ========================================');
    error_log('ADFS: –ò–¢–û–ì–û–í–´–ï –î–ê–ù–ù–´–ï:');
    error_log(print_r($user_info, true));
    error_log('ADFS: ========================================');
    
    if ($debug_mode) {
        echo '<div style="max-width: 1200px; margin: 20px auto; padding: 20px; background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; font-family: monospace; font-size: 12px;">';
        echo '<h2 style="color: #856404;">üìä –ò—Ç–æ–≥–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</h2>';
        echo '<pre style="background: white; padding: 15px; border-radius: 4px; overflow: auto;">';
        print_r($user_info);
        echo '</pre>';
        echo '</div>';
        flush();
    }
    
    error_log('ADFS: Email: ' . ($user_info['email'] ?? '–ù–ï–¢'));
    
    // –°–æ–∑–¥–∞—ë–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    $user = $this->create_or_update_user($user_info);
    
    if (is_wp_error($user)) {
        error_log('ADFS: ‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è!');
        wp_die(
            '<div style="max-width: 800px; margin: 50px auto; padding: 30px; background: white;">' .
            '<h1 style="color: #dc3545;">‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h1>' .
            '<p><strong>–ö–æ–¥:</strong> ' . esc_html($user->get_error_code()) . '</p>' .
            '<p><strong>–°–æ–æ–±—â–µ–Ω–∏–µ:</strong> ' . esc_html($user->get_error_message()) . '</p>' .
            '<details><summary>–î–∞–Ω–Ω—ã–µ –æ—Ç ADFS</summary>' .
            '<pre style="background: #f5f5f5; padding: 10px;">' . print_r($user_info, true) . '</pre>' .
            '</details>' .
            '<a href="' . wp_login_url() . '">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è</a>' .
            '</div>'
        );
    }
    
    error_log('ADFS: ‚úì –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω: ' . $user->user_login);
    
    if ($debug_mode) {
        echo '<div style="max-width: 1200px; margin: 20px auto; padding: 20px; background: #d1f2dd; border: 2px solid #0f5132; border-radius: 8px; text-align: center;">';
        echo '<h2 style="color: #0f5132;">‚úÖ –£—Å–ø–µ—à–Ω–æ!</h2>';
        echo '<p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <strong>' . esc_html($user->user_login) . '</strong></p>';
        echo '<p>Email: <strong>' . esc_html($user->user_email) . '</strong></p>';
        echo '<p>–†–µ–¥–∏—Ä–µ–∫—Ç —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã...</p>';
        echo '</div>';
        flush();
        sleep(3);
    }
    
    // –ê–≤—Ç–æ—Ä–∏–∑—É–µ–º
    wp_set_current_user($user->ID);
    wp_set_auth_cookie($user->ID, true);
    do_action('wp_login', $user->user_login, $user);
    
    error_log('ADFS: ‚úì –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω!');
    error_log('========================================');
    
    wp_safe_redirect(admin_url());
    exit;
}
–ú–µ—Ç–æ–¥ 2: create_or_update_user() - –ü–û–õ–ù–ê–Ø –í–ï–†–°–ò–Ø
phpprivate function create_or_update_user($user_info) {
    error_log('========================================');
    error_log('ADFS: –°–û–ó–î–ê–ù–ò–ï/–û–ë–ù–û–í–õ–ï–ù–ò–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø');
    error_log('========================================');
    error_log('ADFS: –í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: ' . print_r($user_info, true));
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º email
    if (empty($user_info['email'])) {
        error_log('ADFS: ‚ùå Email –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç!');
        return new WP_Error(
            'no_email',
            'ADFS –Ω–µ –≤–µ—Ä–Ω—É–ª email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è',
            $user_info
        );
    }
    
    $email = sanitize_email($user_info['email']);
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º username
    if (!empty($user_info['preferred_username'])) {
        $username = sanitize_user($user_info['preferred_username'], true);
    } elseif (!empty($user_info['upn'])) {
        $username = sanitize_user($user_info['upn'], true);
    } else {
        $username = sanitize_user($email, true);
    }
    
    error_log('ADFS: Email: ' . $email);
    error_log('ADFS: Username: ' . $username);
    
    // Display name
    if (!empty($user_info['name'])) {
        $display_name = $user_info['name'];
    } elseif (!empty($user_info['unique_name'])) {
        $display_name = $user_info['unique_name'];
    } elseif (!empty($user_info['given_name']) && !empty($user_info['family_name'])) {
        $display_name = $user_info['given_name'] . ' ' . $user_info['family_name'];
    } else {
        $display_name = $username;
    }
    
    error_log('ADFS: Display Name: ' . $display_name);
    
    // –ò—â–µ–º –ø–æ email
    $user = get_user_by('email', $email);
    
    // –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω - –∏—â–µ–º –ø–æ sub
    if (!$user && !empty($user_info['sub'])) {
        $users = get_users(array(
            'meta_key' => 'adfs_sid',
            'meta_value' => $user_info['sub'],
            'number' => 1,
        ));
        
        if (!empty($users)) {
            $user = $users[0];
            error_log('ADFS: ‚úì –ù–∞–π–¥–µ–Ω –ø–æ sub');
        }
    }
    
    if (!$user) {
        // –°–æ–∑–¥–∞—ë–º
        error_log('ADFS: –°–æ–∑–¥–∞—é –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...');
        
        $user_data = array(
            'user_login' => $username,
            'user_email' => $email,
            'display_name' => $display_name,
            'first_name' => $user_info['given_name'] ?? '',
            'last_name' => $user_info['family_name'] ?? '',
            'role' => 'subscriber',
            'user_pass' => wp_generate_password(20, true, true),
        );
        
        $user_id = wp_insert_user($user_data);
        
        if (is_wp_error($user_id)) {
            error_log('ADFS: ‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è: ' . $user_id->get_error_message());
            return $user_id;
        }
        
        $user = get_user_by('id', $user_id);
        
        // –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
        update_user_meta($user_id, 'adfs_user', true);
        update_user_meta($user_id, 'adfs_sid', $user_info['sub'] ?? '');
        update_user_meta($user_id, 'adfs_upn', $user_info['upn'] ?? '');
        
        error_log('ADFS: ‚úÖ –°–æ–∑–¥–∞–Ω —Å ID: ' . $user_id);
        
    } else {
        // –û–±–Ω–æ–≤–ª—è–µ–º
        error_log('ADFS: –û–±–Ω–æ–≤–ª—è—é —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ (ID: ' . $user->ID . ')');
        
        wp_update_user(array(
            'ID' => $user->ID,
            'display_name' => $display_name,
            'first_name' => $user_info['given_name'] ?? $user->first_name,
            'last_name' => $user_info['family_name'] ?? $user->last_name,
        ));
        
        update_user_meta($user->ID, 'adfs_user', true);
        update_user_meta($user->ID, 'adfs_sid', $user_info['sub'] ?? '');
        update_user_meta($user->ID, 'adfs_upn', $user_info['upn'] ?? '');
        
        error_log('ADFS: ‚úÖ –û–±–Ω–æ–≤–ª—ë–Ω');
    }
    
    error_log('========================================');
    
    return $user;
}
