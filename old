üéØ –ù–ê–®–õ–ò –ü–†–û–ë–õ–ï–ú–£! –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å Claim Rules!
–û—à–∏–±–∫–∞ –≤ Event Viewer –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:
POLICY3825: The LDAP query 'mail;abs\userAb' is missing one or more required parts.
–ü—Ä–æ–±–ª–µ–º–∞: LDAP –∑–∞–ø—Ä–æ—Å –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å 3 —á–∞—Å—Ç–∏, —Ä–∞–∑–¥–µ–ª—ë–Ω–Ω—ã–µ —Ç–æ—á–∫–æ–π —Å –∑–∞–ø—è—Ç–æ–π, –∞ —Å–µ–π—á–∞—Å —Ç–æ–ª—å–∫–æ 2 —á–∞—Å—Ç–∏!

–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç LDAP –∑–∞–ø—Ä–æ—Å–∞ –≤ ADFS
ADFS —Ç—Ä–µ–±—É–µ—Ç —Ñ–æ—Ä–º–∞—Ç:
filter;attributes;username
–ì–¥–µ:

filter - LDAP —Ñ–∏–ª—å—Ç—Ä (–º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º)
attributes - —Å–ø–∏—Å–æ–∫ –∞—Ç—Ä–∏–±—É—Ç–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä: mail)
username - –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ({0} = –ø–∞—Ä–∞–º–µ—Ç—Ä –∏–∑ incoming claim)


–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Claim Rules –≤ PowerShell
powershellImport-Module ADFS

$ClientId = "a3071ce5-2875-4541-90fb-53c1a5e46aaf"

Write-Host "============================================" -ForegroundColor Cyan
Write-Host "  –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï CLAIM RULES (–ü–†–ê–í–ò–õ–¨–ù–´–ô –°–ò–ù–¢–ê–ö–°–ò–°)" -ForegroundColor Cyan
Write-Host "============================================" -ForegroundColor Cyan
Write-Host ""

$WebApi = Get-AdfsWebApiApplication | Where-Object { $_.Identifier -contains $ClientId }

if (!$WebApi) {
    Write-Host "‚ùå Web API –Ω–µ –Ω–∞–π–¥–µ–Ω!" -ForegroundColor Red
    exit
}

Write-Host "‚úì Web API: $($WebApi.Name)" -ForegroundColor Green
Write-Host ""

# –ü–†–ê–í–ò–õ–¨–ù–´–ï Claim Rules —Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–æ–º LDAP –∑–∞–ø—Ä–æ—Å–æ–≤
$ClaimRules = @"
@RuleName = "Send Email"
c:[Type == "http://schemas.microsoft.com/ws/2008/06/identity/claims/windowsaccountname", Issuer == "AD AUTHORITY"]
 => issue(store = "Active Directory", types = ("http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress", "email"), query = ";mail;{0}", param = c.Value);

@RuleName = "Send Display Name"
c:[Type == "http://schemas.microsoft.com/ws/2008/06/identity/claims/windowsaccountname", Issuer == "AD AUTHORITY"]
 => issue(store = "Active Directory", types = ("http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name", "name"), query = ";displayName;{0}", param = c.Value);

@RuleName = "Send Given Name"
c:[Type == "http://schemas.microsoft.com/ws/2008/06/identity/claims/windowsaccountname", Issuer == "AD AUTHORITY"]
 => issue(store = "Active Directory", types = ("http://schemas.xmlsoap.org/ws/2005/05/identity/claims/givenname", "given_name"), query = ";givenName;{0}", param = c.Value);

@RuleName = "Send Surname"
c:[Type == "http://schemas.microsoft.com/ws/2008/06/identity/claims/windowsaccountname", Issuer == "AD AUTHORITY"]
 => issue(store = "Active Directory", types = ("http://schemas.xmlsoap.org/ws/2005/05/identity/claims/surname", "family_name"), query = ";sn;{0}", param = c.Value);

@RuleName = "Send UPN"
c:[Type == "http://schemas.microsoft.com/ws/2008/06/identity/claims/windowsaccountname", Issuer == "AD AUTHORITY"]
 => issue(store = "Active Directory", types = ("http://schemas.xmlsoap.org/ws/2005/05/identity/claims/upn", "preferred_username"), query = ";userPrincipalName;{0}", param = c.Value);
"@

Write-Host "–ü—Ä–∏–º–µ–Ω—è—é –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ Claim Rules..." -ForegroundColor Yellow

try {
    Set-AdfsWebApiApplication -TargetName $WebApi.Name -IssuanceTransformRules $ClaimRules
    Write-Host "‚úì Claim Rules –æ–±–Ω–æ–≤–ª–µ–Ω—ã —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–æ–º!" -ForegroundColor Green
} catch {
    Write-Host "‚ùå –û—à–∏–±–∫–∞: $_" -ForegroundColor Red
    Write-Host ""
    Write-Host "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏—Å–ø—Ä–∞–≤–∏—Ç—å —á–µ—Ä–µ–∑ GUI (–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –Ω–∏–∂–µ)" -ForegroundColor Yellow
}
