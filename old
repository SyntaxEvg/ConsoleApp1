using System;
using System.Collections.Generic;
using System.Linq;
using System.Linq.Expressions;
using System.Security.Claims;
using System.Security.Cryptography.X509Certificates;
using System.Text.Json;
using System.Text.Json.Serialization;
using Mega.Has.Commons.Security;
using Mega.Has.Modules.UAS.Models;
using Mega.Has.Modules.UAS.Stores;
using Microsoft.AspNetCore.Authentication;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Logging;
using Microsoft.IdentityModel.Tokens.Saml2;
using Sustainsys.Saml2;
using Sustainsys.Saml2.AspNetCore2;
using Sustainsys.Saml2.Configuration;
using Sustainsys.Saml2.Metadata;
using Sustainsys.Saml2.Saml2P;
using Sustainsys.Saml2.Tokens;
using Sustainsys.Saml2.WebSso;

namespace Mega.Has.Modules.UAS.Providers.Saml2
{
	// Token: 0x0200007B RID: 123
	public class Saml2Provider : IIdentityProvider<Saml2Config>, IExternalProvider
	{
		// Token: 0x0600051D RID: 1309 RVA: 0x00011110 File Offset: 0x0000F310
		private ValueTuple<SPOptions, IdentityProvider> buildOptions(Saml2Config Configuration)
		{
			ICryptoService cryptoService = this._serviceProvider.GetRequiredService<ICryptoService>();
			string publicOrigin = cryptoService.Configuration.RuntimeClusterSettings.PublicAddress;
			string uasUrl = publicOrigin.TrimEnd('/') + "/UAS";
			SPOptions spOptions = new SPOptions();
			spOptions.ModulePath = Configuration.ModulePath;
			spOptions.EntityId = new EntityId(uasUrl);
			spOptions.AuthenticateRequestSigningBehavior = this.ParseAuthenticateRequestSigningBehavior(Configuration.AuthenticateRequestSigningBehavior);
			spOptions.ReturnUrl = new Uri(publicOrigin);
			spOptions.WantAssertionsSigned = Configuration.WantAssertionSigned;
			spOptions.Logger = new AspNetCoreLoggerAdapter(this._logger);
			spOptions.PublicOrigin = new Uri(uasUrl);
			IdentityProvider identityProvider = new IdentityProvider(new EntityId(Configuration.EntityId), spOptions)
			{
				MetadataLocation = Configuration.MetadataLocation,
				LoadMetadata = !string.IsNullOrEmpty(Configuration.MetadataLocation),
				AllowUnsolicitedAuthnResponse = Configuration.AllowUnsolicitedAuthnResponse,
				Binding = this.ParsingBindingType(Configuration.BindingType),
				OutboundSigningAlgorithm = this.ParseSigninAlgorithms(Configuration.OutboundSigningAlgorithm),
				WantAuthnRequestsSigned = Configuration.WantAuthnRequestsSigned
			};
			if (!string.IsNullOrEmpty(Configuration.CertificateName))
			{
				spOptions.ValidateCertificates = false;
				X509Certificate2 certificate = CertificateManager.FindCertificateByFriendlyNamePassword(Configuration.CertificateName, StoreName.My, StoreLocation.LocalMachine);
				if (certificate == null)
				{
					ILogger logger = this._logger;
					if (logger != null)
					{
						logger.LogError("Certificate with name " + Configuration.CertificateName + " is not recognized or installed.", Array.Empty<object>());
					}
				}
				else if (certificate.NotAfter <= DateTime.Now)
				{
					ILogger logger2 = this._logger;
					if (logger2 != null)
					{
						logger2.LogError("Certificate with name " + Configuration.CertificateName + " is expired.", Array.Empty<object>());
					}
				}
				else
				{
					ILogger logger3 = this._logger;
					if (logger3 != null)
					{
						logger3.LogInformation("Certificate with name " + certificate.FriendlyName + " is recognized ", Array.Empty<object>());
					}
					spOptions.ServiceCertificates.Add(new ServiceCertificate
					{
						Certificate = certificate,
						Use = this.ParseCertificateUse(Configuration.CertificateUse),
						Status = CertificateStatus.Current
					});
					identityProvider.SigningKeys.AddConfiguredKey(new X509RawDataKeyIdentifierClause(certificate));
				}
			}
			if (Configuration.ContactPerson != null)
			{
				ContactPerson contact = new ContactPerson();
				contact.EmailAddresses.Add(Configuration.ContactPerson.Email);
				contact.Type = ((Configuration.ContactPerson.Type == "Administrative") ? ContactType.Administrative : ContactType.Billing);
				spOptions.Contacts.Add(contact);
			}
			if (Configuration.Organization != null)
			{
				spOptions.Organization = new Organization();
				UasOrganization organization = Configuration.Organization;
				if (!string.IsNullOrEmpty((organization != null) ? organization.Name : null))
				{
					spOptions.Organization.Names.Add(new LocalizedName(Configuration.Organization.Name, Configuration.Organization.Language));
				}
				UasOrganization organization2 = Configuration.Organization;
				if (!string.IsNullOrEmpty((organization2 != null) ? organization2.DisplayName : null))
				{
					spOptions.Organization.DisplayNames.Add(new LocalizedName(Configuration.Organization.DisplayName, Configuration.Organization.Language));
				}
				UasOrganization organization3 = Configuration.Organization;
				if (!string.IsNullOrEmpty((organization3 != null) ? organization3.Url : null))
				{
					spOptions.Organization.Urls.Add(new LocalizedUri(new Uri(Configuration.Organization.Url), Configuration.Organization.Language));
				}
			}
			return new ValueTuple<SPOptions, IdentityProvider>(spOptions, identityProvider);
		}

		// Token: 0x17000226 RID: 550
		// (get) Token: 0x0600051E RID: 1310 RVA: 0x00011475 File Offset: 0x0000F675
		// (set) Token: 0x0600051F RID: 1311 RVA: 0x0001147D File Offset: 0x0000F67D
		public bool Enabled { get; set; }

		// Token: 0x17000227 RID: 551
		// (get) Token: 0x06000520 RID: 1312 RVA: 0x00011486 File Offset: 0x0000F686
		// (set) Token: 0x06000521 RID: 1313 RVA: 0x0001148E File Offset: 0x0000F68E
		public string DisplayName { get; set; } = "Saml2";

		// Token: 0x17000228 RID: 552
		// (get) Token: 0x06000522 RID: 1314 RVA: 0x00011497 File Offset: 0x0000F697
		// (set) Token: 0x06000523 RID: 1315 RVA: 0x0001149F File Offset: 0x0000F69F
		public string AuthenticationScheme { get; set; } = "Saml2";

		// Token: 0x17000229 RID: 553
		// (get) Token: 0x06000524 RID: 1316 RVA: 0x000114A8 File Offset: 0x0000F6A8
		// (set) Token: 0x06000525 RID: 1317 RVA: 0x000114B0 File Offset: 0x0000F6B0
		public Saml2Config Configuration { get; set; } = new Saml2Config();

		// Token: 0x06000526 RID: 1318 RVA: 0x000114BC File Offset: 0x0000F6BC
		public Saml2Provider(ILoggerFactory loggerFactory, ApplicationDbContext context, IServiceProvider serviceProvider)
		{
			this._loggerFactory = loggerFactory;
			this._context = context;
			this._serviceProvider = serviceProvider;
			this._logger = loggerFactory.CreateLogger(typeof(Saml2Provider));
			this._jsonSerializerOptions = new JsonSerializerOptions
			{
				IgnoreReadOnlyFields = true,
				DefaultIgnoreCondition = JsonIgnoreCondition.WhenWritingDefault,
				Converters = 
				{
					new IntPtrConverter()
				}
			};
		}

		// Token: 0x06000527 RID: 1319 RVA: 0x00011550 File Offset: 0x0000F750
		public void Configure(AuthenticationBuilder builder)
		{
			IQueryable<ExternalProvider> externalProviders = this._context.ExternalProviders;
			ParameterExpression parameterExpression = Expression.Parameter(typeof(ExternalProvider), "x");
			IQueryable<ExternalProvider> entities = externalProviders.Where(Expression.Lambda<Func<ExternalProvider, bool>>(Expression.Equal(Expression.Property(parameterExpression, methodof(ExternalProvider.get_Type())), Expression.Constant("Saml2Config", typeof(string))), new ParameterExpression[] { parameterExpression }));
			using (IEnumerator<ExternalProvider> enumerator = entities.GetEnumerator())
			{
				while (enumerator.MoveNext())
				{
					ExternalProvider externalProvider = enumerator.Current;
					if (externalProvider != null && externalProvider.Enabled)
					{
						this.Configuration = externalProvider.GetConfiguration<Saml2Config>();
						if (string.IsNullOrEmpty(this.Configuration.EntityId))
						{
							throw new ArgumentException("Please set Entity Id field when you activate SAML2 Provider");
						}
						this.Configuration = externalProvider.GetConfiguration<Saml2Config>();
						ValueTuple<SPOptions, IdentityProvider> valueTuple = this.buildOptions(this.Configuration);
						SPOptions options2 = valueTuple.Item1;
						IdentityProvider idp = valueTuple.Item2;
						this.configs.Add((options2.PublicOrigin.ToString() + options2.ModulePath + "/Acs").ToLower(), this.Configuration);
						builder.AddSaml2(this.Configuration.DisplayName, delegate(Saml2Options options)
						{
							this.Configuration = externalProvider.GetConfiguration<Saml2Config>();
							options.SignInScheme = "idsrv.external";
							options.CookieManager = new Saml2CookieManager(this._logger);
							try
							{
								ValueTuple<SPOptions, IdentityProvider> valueTuple2 = this.buildOptions(this.Configuration);
								options.SPOptions = valueTuple2.Item1;
								IdentityProvider identityProvider = valueTuple2.Item2;
								options.IdentityProviders.Add(identityProvider);
							}
							catch (Exception ex)
							{
								this._logger.LogError(ex.Message, Array.Empty<object>());
							}
							options.Notifications.SignInCommandResultCreated = new Action<CommandResult, IDictionary<string, string>>(this.OnSignInCommandResultCreated);
							options.Notifications.AcsCommandResultCreated = new Action<CommandResult, Saml2Response>(this.OnAcsCommandResultCreated);
							options.Notifications.AuthenticationRequestCreated = new Action<Saml2AuthenticationRequest, IdentityProvider, IDictionary<string, string>>(this.OnAuthenticationRequestCreated);
							options.Notifications.MessageUnbound = new Action<UnbindResult>(this.OnMessageAcsUnbound);
							options.Notifications.LogoutCommandResultCreated = new Action<CommandResult>(this.OnLogoutCommandResultCreated);
							options.Notifications.MetadataCommandResultCreated = new Action<CommandResult>(this.OnMetadataCommandResultCreated);
							options.Notifications.MetadataCreated = new Action<EntityDescriptor, Saml2Urls>(this.MetadataCreated);
							options.Notifications.EmitSameSiteNone = new Func<string, bool>(this.shouldSendSameSiteNone);
						});
					}
				}
			}
		}

		// Token: 0x06000528 RID: 1320 RVA: 0x000116D4 File Offset: 0x0000F8D4
		private bool shouldSendSameSiteNone(string useragent)
		{
			return true;
		}

		// Token: 0x06000529 RID: 1321 RVA: 0x000116D8 File Offset: 0x0000F8D8
		private Saml2BindingType ParsingBindingType(string saml2ConfigurationBindingType)
		{
			Saml2BindingType saml2BindingType;
			if (!(saml2ConfigurationBindingType == "HttpPost"))
			{
				if (!(saml2ConfigurationBindingType == "Artifact"))
				{
					if (!(saml2ConfigurationBindingType == "HttpRedirect"))
					{
						saml2BindingType = Saml2BindingType.HttpPost;
					}
					else
					{
						saml2BindingType = Saml2BindingType.HttpRedirect;
					}
				}
				else
				{
					saml2BindingType = Saml2BindingType.Artifact;
				}
			}
			else
			{
				saml2BindingType = Saml2BindingType.HttpPost;
			}
			return saml2BindingType;
		}

		// Token: 0x0600052A RID: 1322 RVA: 0x00011720 File Offset: 0x0000F920
		private SigningBehavior ParseAuthenticateRequestSigningBehavior(string authenticateRequestSigningBehavior)
		{
			SigningBehavior signingBehavior;
			if (!(authenticateRequestSigningBehavior == "IfIdpWantAuthnRequestsSigned"))
			{
				if (!(authenticateRequestSigningBehavior == "Always"))
				{
					if (!(authenticateRequestSigningBehavior == "Never"))
					{
						signingBehavior = SigningBehavior.IfIdpWantAuthnRequestsSigned;
					}
					else
					{
						signingBehavior = SigningBehavior.Never;
					}
				}
				else
				{
					signingBehavior = SigningBehavior.Always;
				}
			}
			else
			{
				signingBehavior = SigningBehavior.IfIdpWantAuthnRequestsSigned;
			}
			return signingBehavior;
		}

		// Token: 0x0600052B RID: 1323 RVA: 0x00011768 File Offset: 0x0000F968
		private CertificateUse ParseCertificateUse(string certificateUse)
		{
			CertificateUse certificateUse2;
			if (!(certificateUse == "Both"))
			{
				if (!(certificateUse == "Signing"))
				{
					if (!(certificateUse == "Encryption"))
					{
						certificateUse2 = CertificateUse.Both;
					}
					else
					{
						certificateUse2 = CertificateUse.Encryption;
					}
				}
				else
				{
					certificateUse2 = CertificateUse.Signing;
				}
			}
			else
			{
				certificateUse2 = CertificateUse.Both;
			}
			return certificateUse2;
		}

		// Token: 0x0600052C RID: 1324 RVA: 0x000117B0 File Offset: 0x0000F9B0
		private string ParseSigninAlgorithms(string outboundSigningAlgorithm)
		{
			string text;
			if (!(outboundSigningAlgorithm == "SHA256"))
			{
				if (!(outboundSigningAlgorithm == "SHA512"))
				{
					text = "http://www.w3.org/2001/04/xmldsig-more#rsa-sha256";
				}
				else
				{
					text = "http://www.w3.org/2001/04/xmldsig-more#rsa-sha512";
				}
			}
			else
			{
				text = "http://www.w3.org/2001/04/xmldsig-more#rsa-sha256";
			}
			return text;
		}

		// Token: 0x0600052D RID: 1325 RVA: 0x000117F0 File Offset: 0x0000F9F0
		private void MetadataCreated(EntityDescriptor arg1, Saml2Urls arg2)
		{
			ILogger logger = this._logger;
			if (logger != null)
			{
				logger.LogInformation("OnMetadataCreated ExtendedEntityDescriptor => " + JsonSerializer.Serialize<EntityDescriptor>(arg1, this._jsonSerializerOptions), Array.Empty<object>());
			}
			ILogger logger2 = this._logger;
			if (logger2 == null)
			{
				return;
			}
			logger2.LogInformation("OnMetadataCreated Saml2Urls => " + JsonSerializer.Serialize<Saml2Urls>(arg2, this._jsonSerializerOptions), Array.Empty<object>());
		}

		// Token: 0x0600052E RID: 1326 RVA: 0x00011854 File Offset: 0x0000FA54
		private void OnMetadataCommandResultCreated(CommandResult obj)
		{
			this._logger.LogInformation("OnMetadataCommandResultCreated => " + JsonSerializer.Serialize<CommandResult>(obj, this._jsonSerializerOptions), Array.Empty<object>());
		}

		// Token: 0x0600052F RID: 1327 RVA: 0x0001187C File Offset: 0x0000FA7C
		private void OnMessageAcsUnbound(UnbindResult obj)
		{
			this._logger.LogInformation("OnMessageAcsUnbound UnbindResult => " + JsonSerializer.Serialize<UnbindResult>(obj, this._jsonSerializerOptions), Array.Empty<object>());
		}

		// Token: 0x06000530 RID: 1328 RVA: 0x000118A4 File Offset: 0x0000FAA4
		private void OnAuthenticationRequestCreated(Saml2AuthenticationRequest arg1, IdentityProvider arg2, IDictionary<string, string> arg3)
		{
			this._logger.LogInformation("OnAuthenticationRequestCreated Saml2AuthenticationRequest => " + JsonSerializer.Serialize<Saml2AuthenticationRequest>(arg1, this._jsonSerializerOptions), Array.Empty<object>());
			this._logger.LogInformation("OnAuthenticationRequestCreated IdentityProvider => " + JsonSerializer.Serialize<IdentityProvider>(arg2, this._jsonSerializerOptions), Array.Empty<object>());
			this._logger.LogInformation("OnAuthenticationRequestCreated properties => " + JsonSerializer.Serialize<IDictionary<string, string>>(arg3, this._jsonSerializerOptions), Array.Empty<object>());
		}

		// Token: 0x06000531 RID: 1329 RVA: 0x00011924 File Offset: 0x0000FB24
		private void OnAcsCommandResultCreated(CommandResult cmdResult, Saml2Response saml2Response)
		{
			Saml2Config config = null;
			string saml2ResponseJson = JsonSerializer.Serialize<Saml2Response>(saml2Response, this._jsonSerializerOptions);
			if (this.configs.Count == 1)
			{
				config = this.configs.First<KeyValuePair<string, Saml2Config>>().Value;
			}
			else if (saml2Response.DestinationUrl != null && !string.IsNullOrEmpty(saml2Response.DestinationUrl.ToString()))
			{
				config = this.configs[saml2Response.DestinationUrl.ToString().ToLower()];
			}
			else
			{
				foreach (KeyValuePair<string, Saml2Config> item in this.configs)
				{
					if (saml2ResponseJson.Contains(item.Key, StringComparison.OrdinalIgnoreCase))
					{
						config = item.Value;
						break;
					}
				}
			}
			if (config == null)
			{
				this._logger.LogError("OnAcsCommandResultCreated: no configuration corresponds to the saml2 response => " + saml2ResponseJson, Array.Empty<object>());
				throw new ArgumentNullException("DestinationUrl Saml2");
			}
			ClaimsIdentity identity = cmdResult.Principal.Identity as ClaimsIdentity;
			if (identity != null)
			{
				if (!string.IsNullOrEmpty(config.GroupsAuthorized))
				{
					cmdResult.Principal.FindAll((Claim x) => x.Type == config.ClaimForRoles && !this.Configuration.GroupsAuthorized.Contains(x.Value)).ToList<Claim>().ForEach(new Action<Claim>(identity.RemoveClaim));
				}
				bool bAddClaimSub = true;
				if (!string.IsNullOrEmpty(config.ClaimForSub) && config.ClaimForSub.ToLower() != "sub")
				{
					Claim claim = cmdResult.Principal.Claims.FirstOrDefault((Claim x) => x.Type == this.Configuration.ClaimForSub);
					string value = ((claim != null) ? claim.Value : null);
					if (value != null)
					{
						cmdResult.Principal.FindAll((Claim x) => x.Type.ToLower() == "sub").ToList<Claim>().ForEach(new Action<Claim>(identity.RemoveClaim));
						identity.AddClaim(new Claim("sub", value));
						bAddClaimSub = false;
					}
					else
					{
						this._logger.LogInformation("The claim for sub " + this.Configuration.ClaimForSub + " not found!", Array.Empty<object>());
					}
				}
				if (bAddClaimSub && cmdResult.Principal.FindFirst("sub") == null)
				{
					Saml2NameIdentifier saml2NameIdentifier = identity.ToSaml2NameIdentifier();
					identity.AddClaim(new Claim("sub", saml2NameIdentifier.Value));
				}
				if (!string.IsNullOrEmpty(config.ClaimForSub) && config.ClaimForSub.ToLower() != "name" && cmdResult.Principal.FindFirst("sub") != null)
				{
					identity.AddClaim(new Claim("UseSubAsLogin", "true"));
				}
			}
			this._logger.LogInformation("OnAcsCommandResultCreated: Saml2Response => " + saml2ResponseJson, Array.Empty<object>());
		}

		// Token: 0x06000532 RID: 1330 RVA: 0x00011C3C File Offset: 0x0000FE3C
		private void OnSignInCommandResultCreated(CommandResult arg1, IDictionary<string, string> arg2)
		{
			this._logger.LogInformation("OnSignInCommandResultCreated properties => " + JsonSerializer.Serialize<IDictionary<string, string>>(arg2, this._jsonSerializerOptions), Array.Empty<object>());
		}

		// Token: 0x06000533 RID: 1331 RVA: 0x00011C64 File Offset: 0x0000FE64
		private void OnLogoutCommandResultCreated(CommandResult obj)
		{
			this._logger.LogInformation("LogoutCommandResultCreated => " + obj.Content, Array.Empty<object>());
		}

		// Token: 0x06000534 RID: 1332 RVA: 0x00011C88 File Offset: 0x0000FE88
		public bool IsValid()
		{
			IQueryable<ExternalProvider> externalProviders = this._context.ExternalProviders;
			ParameterExpression parameterExpression = Expression.Parameter(typeof(ExternalProvider), "x");
			ExternalProvider externalProvider = externalProviders.FirstOrDefault(Expression.Lambda<Func<ExternalProvider, bool>>(Expression.Equal(Expression.Property(parameterExpression, methodof(ExternalProvider.get_Type())), Expression.Constant("Saml2Config", typeof(string))), new ParameterExpression[] { parameterExpression }));
			return externalProvider != null && externalProvider.Enabled;
		}

		// Token: 0x04000420 RID: 1056
		public const string Name = "Saml2";

		// Token: 0x04000421 RID: 1057
		private readonly ILoggerFactory _loggerFactory;

		// Token: 0x04000422 RID: 1058
		private readonly ApplicationDbContext _context;

		// Token: 0x04000423 RID: 1059
		private readonly IServiceProvider _serviceProvider;

		// Token: 0x04000424 RID: 1060
		private readonly ILogger _logger;

		// Token: 0x04000425 RID: 1061
		private readonly JsonSerializerOptions _jsonSerializerOptions;

		// Token: 0x04000426 RID: 1062
		private readonly Dictionary<string, Saml2Config> configs = new Dictionary<string, Saml2Config>();
	}
}
