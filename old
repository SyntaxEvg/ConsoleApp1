using System;
using System.Collections.Generic;
using System.Linq;
using Dapper;
using IdentityServer4.EntityFramework.DbContexts;
using IdentityServer4.EntityFramework.Entities;
using IdentityServer4.EntityFramework.Mappers;
using Mega.Has.Commons;
using Mega.Has.Commons.Security;
using Mega.Has.Modules.UAS.Models;
using Microsoft.AspNetCore.Authentication;
using Microsoft.Data.SqlClient;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Query;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Logging;
using Serilog;

namespace Mega.Has.Modules.UAS
{
    public class SeedData
    {
        public static void EnsureSeedData(IServiceCollection serviceCollection, IClusterConfiguration serverConfigurations, AuthenticationBuilder authenticationBuilder)
        {
            Log.Information("=== EnsureSeedData: НАЧАЛО ===");
            
            ServiceProvider services = null;
            try
            {
                Log.Information("Шаг 1: BuildServiceProvider...");
                services = serviceCollection.BuildServiceProvider();
                Log.Information("Шаг 1: BuildServiceProvider - OK");
            }
            catch (Exception ex)
            {
                Log.Error(ex, "ОШИБКА на шаге 1: BuildServiceProvider");
                throw;
            }

            using (IServiceScope scope = services.GetRequiredService<IServiceScopeFactory>().CreateScope())
            {
                ApplicationDbContext uasContext = null;
                ConfigurationDbContext context = null;
                ILogger<SeedData> logger = null;

                try
                {
                    Log.Information("Шаг 2: Получение ApplicationDbContext...");
                    uasContext = scope.ServiceProvider.GetService<ApplicationDbContext>();
                    Log.Information($"Шаг 2: ApplicationDbContext = {(uasContext != null ? "OK" : "NULL")}");

                    Log.Information("Шаг 3: Получение ConfigurationDbContext...");
                    context = scope.ServiceProvider.GetService<ConfigurationDbContext>();
                    Log.Information($"Шаг 3: ConfigurationDbContext = {(context != null ? "OK" : "NULL")}");

                    Log.Information("Шаг 4: Получение ILogger...");
                    logger = services.GetService<ILogger<SeedData>>();
                    Log.Information($"Шаг 4: ILogger = {(logger != null ? "OK" : "NULL")}");
                }
                catch (Exception ex)
                {
                    Log.Error(ex, "ОШИБКА при получении сервисов (шаги 2-4)");
                    throw;
                }

                // Проверяем context на null
                if (context == null)
                {
                    Log.Error("ОШИБКА: ConfigurationDbContext равен NULL!");
                    throw new InvalidOperationException("ConfigurationDbContext is null");
                }

                bool isInMemory = false;
                try
                {
                    Log.Information("Шаг 5: Проверка IsInMemory...");
                    Log.Information($"Шаг 5.1: context.Database = {(context.Database != null ? "OK" : "NULL")}");
                    
                    isInMemory = context.Database.IsInMemory();
                    Log.Information($"Шаг 5: IsInMemory = {isInMemory}");
                }
                catch (Exception ex)
                {
                    Log.Error(ex, "ОШИБКА на шаге 5: IsInMemory");
                    throw;
                }

                if (!isInMemory)
                {
                    Log.Information("=== Режим SQL Server (не InMemory) ===");
                    try
                    {
                        Log.Information("Шаг 6: Получение ICryptoService...");
                        ICryptoService cryptoService = services.GetRequiredService<ICryptoService>();
                        Log.Information($"Шаг 6: ICryptoService = {(cryptoService != null ? "OK" : "NULL")}");

                        Log.Information("Шаг 7: Вызов MigrateDatabase...");
                        MigrateDatabase(logger, services, cryptoService);
                        Log.Information("Шаг 7: MigrateDatabase - OK");

                        Log.Information("Шаг 8: EnsureSeedData (с cryptoService)...");
                        EnsureSeedData(logger, serverConfigurations, uasContext, context, cryptoService);
                        Log.Information("Шаг 8: EnsureSeedData - OK");

                        Log.Information("Шаг 9: EnsureSeedData (uasContext)...");
                        EnsureSeedData(logger, uasContext);
                        Log.Information("Шаг 9: EnsureSeedData - OK");

                        Log.Information("Шаг 10: EnsurePublicAddress...");
                        string publicAddress = serverConfigurations.RuntimeClusterSettings.PublicAddress;
                        RunningMode? mode = serverConfigurations.RuntimeClusterSettings.Mode;
                        bool isDevelopment = (mode.GetValueOrDefault() == RunningMode.Development) & (mode != null);
                        Log.Information($"Шаг 10: publicAddress = {publicAddress}, isDevelopment = {isDevelopment}");
                        
                        EnsurePublicAddress(logger, context, publicAddress, isDevelopment);
                        Log.Information("Шаг 10: EnsurePublicAddress - OK");
                    }
                    catch (Exception ex)
                    {
                        Log.Error(ex, "ОШИБКА в блоке SQL Server");
                        throw;
                    }
                    finally
                    {
                        bool? testMode = serverConfigurations.StartingArguments.TestMode;
                        bool flag = false;
                        if ((testMode.GetValueOrDefault() == flag) & (testMode != null))
                        {
                            Log.Information("Закрытие соединения с БД...");
                            context.Database.CloseConnection();
                        }
                    }
                }
                else
                {
                    Log.Information("=== Режим InMemory ===");
                    try
                    {
                        EnsureSeedData(logger, serverConfigurations, uasContext, context, null);
                        EnsureSeedData(logger, uasContext);
                    }
                    catch (Exception ex)
                    {
                        Log.Error(ex, "ОШИБКА в блоке InMemory");
                        throw;
                    }
                }
            }

            Log.Information("=== EnsureSeedData: КОНЕЦ ===");
        }

        private static void MigrateDatabase(Microsoft.Extensions.Logging.ILogger logger, IServiceProvider services, ICryptoService cryptoService)
        {
            Log.Information("=== MigrateDatabase: НАЧАЛО ===");

            try
            {
                Log.Information("Проверка Standalone режима...");
                bool? standalone = cryptoService.Configuration.StartingArguments.Standalone;
                Log.Information($"Standalone = {standalone}");

                bool isStandalone = (standalone.GetValueOrDefault() == true) & (standalone != null);
                Log.Information($"isStandalone = {isStandalone}");

                if (!isStandalone)
                {
                    Log.Information("=== SQL Server миграция ===");
                    
                    // ApplicationDbContext
                    try
                    {
                        Log.Information("Миграция 1: Получение ApplicationDbContext...");
                        var appDbContext = services.GetRequiredService<ApplicationDbContext>();
                        Log.Information($"Миграция 1: ApplicationDbContext = {(appDbContext != null ? "OK" : "NULL")}");
                        
                        Log.Information("Миграция 1: Проверка Database...");
                        var database = appDbContext.Database;
                        Log.Information($"Миграция 1: Database = {(database != null ? "OK" : "NULL")}");
                        
                        Log.Information("Миграция 1: Проверка ProviderName...");
                        var providerName = database.ProviderName;
                        Log.Information($"Миграция 1: ProviderName = {providerName}");
                        
                        Log.Information("Миграция 1: Проверка ConnectionString...");
                        var connectionString = database.GetConnectionString();
                        Log.Information($"Миграция 1: ConnectionString = {(string.IsNullOrEmpty(connectionString) ? "ПУСТАЯ или NULL!" : "OK (длина: " + connectionString.Length + ")")}");
                        
                        if (string.IsNullOrEmpty(connectionString))
                        {
                            Log.Error("КРИТИЧЕСКАЯ ОШИБКА: Connection string пустая!");
                            throw new InvalidOperationException("Connection string is null or empty for ApplicationDbContext");
                        }
                        
                        Log.Information("Миграция 1: Вызов Migrate()...");
                        database.Migrate();
                        Log.Information("Миграция 1: ApplicationDbContext.Migrate() - OK");
                    }
                    catch (Exception ex)
                    {
                        Log.Error(ex, "ОШИБКА при миграции ApplicationDbContext");
                        throw;
                    }

                    // ConfigurationDbContext
                    try
                    {
                        Log.Information("Миграция 2: Получение ConfigurationDbContext...");
                        var configDbContext = services.GetRequiredService<ConfigurationDbContext>();
                        
                        Log.Information("Миграция 2: Проверка ConnectionString...");
                        var connectionString = configDbContext.Database.GetConnectionString();
                        Log.Information($"Миграция 2: ConnectionString = {(string.IsNullOrEmpty(connectionString) ? "ПУСТАЯ или NULL!" : "OK")}");
                        
                        Log.Information("Миграция 2: Вызов Migrate()...");
                        configDbContext.Database.Migrate();
                        Log.Information("Миграция 2: ConfigurationDbContext.Migrate() - OK");
                    }
                    catch (Exception ex)
                    {
                        Log.Error(ex, "ОШИБКА при миграции ConfigurationDbContext");
                        throw;
                    }

                    // PersistedGrantDbContext
                    try
                    {
                        Log.Information("Миграция 3: Получение PersistedGrantDbContext...");
                        var grantDbContext = services.GetRequiredService<PersistedGrantDbContext>();
                        
                        Log.Information("Миграция 3: Проверка ConnectionString...");
                        var connectionString = grantDbContext.Database.GetConnectionString();
                        Log.Information($"Миграция 3: ConnectionString = {(string.IsNullOrEmpty(connectionString) ? "ПУСТАЯ или NULL!" : "OK")}");
                        
                        Log.Information("Миграция 3: Вызов Migrate()...");
                        grantDbContext.Database.Migrate();
                        Log.Information("Миграция 3: PersistedGrantDbContext.Migrate() - OK");
                    }
                    catch (Exception ex)
                    {
                        Log.Error(ex, "ОШИБКА при миграции PersistedGrantDbContext");
                        throw;
                    }

                    // Дополнительные миграции
                    try
                    {
                        Log.Information("Шаг 4: Получение DatabaseConnectionString...");
                        string cnx = cryptoService.Configuration.RuntimeClusterSettings.GetDatabaseConnectionString(true);
                        Log.Information($"Шаг 4: DatabaseConnectionString = {(string.IsNullOrEmpty(cnx) ? "ПУСТАЯ или NULL!" : "OK (длина: " + cnx.Length + ")")}");

                        if (string.IsNullOrEmpty(cnx))
                        {
                            Log.Error("КРИТИЧЕСКАЯ ОШИБКА: DatabaseConnectionString пустая!");
                            throw new InvalidOperationException("DatabaseConnectionString is null or empty");
                        }

                        Log.Information("Шаг 5: Migrate_HAS_5_0To5_0_1...");
                        Migrate_HAS_5_0To5_0_1(cnx);
                        Log.Information("Шаг 5: Migrate_HAS_5_0To5_0_1 - OK");

                        Log.Information("Шаг 6: Migrate_HAS_5_0_xTo5_0_5...");
                        Migrate_HAS_5_0_xTo5_0_5(cnx);
                        Log.Information("Шаг 6: Migrate_HAS_5_0_xTo5_0_5 - OK");

                        Log.Information("Шаг 7: SQLCacheTableCreator...");
                        SQLCacheTableCreator slqCreator = new SQLCacheTableCreator();
                        int result = slqCreator.CreateTableAndIndexes(cnx);
                        Log.Information($"Шаг 7: SQLCacheTableCreator result = {result}");
                        
                        if (result != 0)
                        {
                            throw new Exception("Unable to create cache tables in database");
                        }
                    }
                    catch (Exception ex)
                    {
                        Log.Error(ex, "ОШИБКА в дополнительных миграциях (шаги 4-7)");
                        throw;
                    }
                }
                else
                {
                    Log.Information("=== SQLite режим (Standalone) ===");
                    
                    try
                    {
                        Log.Information("SQLite: ApplicationDbContext...");
                        EnsureSQLiteDatabaseCreated(services.GetRequiredService<ApplicationDbContext>().Database);
                        Log.Information("SQLite: ApplicationDbContext - OK");

                        Log.Information("SQLite: ConfigurationDbContext...");
                        EnsureSQLiteDatabaseCreated(services.GetRequiredService<ConfigurationDbContext>().Database);
                        Log.Information("SQLite: ConfigurationDbContext - OK");

                        Log.Information("SQLite: PersistedGrantDbContext...");
                        EnsureSQLiteDatabaseCreated(services.GetRequiredService<PersistedGrantDbContext>().Database);
                        Log.Information("SQLite: PersistedGrantDbContext - OK");
                    }
                    catch (Exception ex)
                    {
                        Log.Error(ex, "ОШИБКА в SQLite режиме");
                        throw;
                    }
                }
            }
            catch (Exception ex)
            {
                Log.Error(ex, "=== MigrateDatabase: КРИТИЧЕСКАЯ ОШИБКА ===");
                throw;
            }

            Log.Information("=== MigrateDatabase: КОНЕЦ ===");
        }

        private static void EnsureSQLiteDatabaseCreated(DatabaseFacade database)
        {
            string sql = database.GenerateCreateScript();
            try
            {
                database.ExecuteSqlRaw(sql, Array.Empty<object>());
            }
            catch
            {
                // Игнорируем ошибки (таблицы могут уже существовать)
            }
        }

        // ... остальные методы оставляем без изменений ...
        // (Migrate_HAS_5_0To5_0_1, Migrate_HAS_5_0_xTo5_0_5, и т.д.)
        
        internal static void Migrate_HAS_5_0To5_0_1(string cnxString)
        {
            Log.Information($"Migrate_HAS_5_0To5_0_1: Открытие соединения...");
            using (SqlConnection connection = new SqlConnection(cnxString))
            {
                Log.Information($"Migrate_HAS_5_0To5_0_1: Соединение создано, State = {connection.State}");
                
                MigrateOldConfigTable<WindowsConfig>(connection);
                MigrateOldConfigTable<HopexConfig>(connection);
                MigrateOldConfigTable<Saml2Config>(connection);
                MigrateOldConfigTable<OpenIdConfig>(connection);
                
                try
                {
                    foreach (IdentityServer4.Models.ApiResource resource in DefaultConfiguration.GetApiResources().ToList())
                    {
                        var apiResource = connection.Query<IdentityServer4.EntityFramework.Entities.ApiResource>(
                            $"select * from [dbo].[ApiResources] where Name='{resource.Name}'").FirstOrDefault();
                            
                        if (apiResource != null)
                        {
                            var existingScope = connection.Query<ApiResourceScope>(
                                $"select * from [dbo].[ApiResourceScopes] where ApiResourceId='{apiResource.Id}'").FirstOrDefault();
                                
                            if (existingScope == null)
                            {
                                var p = new
                                {
                                    ApiResourceId = apiResource.Id,
                                    Scope = resource.Scopes.First()
                                };
                                connection.Execute("insert into [dbo].[ApiResourceScopes] (ApiResourceId, Scope) values( @ApiResourceId, @Scope)", p);
                            }
                        }
                    }
                }
                catch (Exception ex)
                {
                    Log.Logger.Error(ex, "Warning");
                }
            }
        }

        internal static void Migrate_HAS_5_0_xTo5_0_5(string cnxString)
        {
            using (SqlConnection connection = new SqlConnection(cnxString))
            {
                try
                {
                    updateClaimForSub<OpenIdConfig>(connection);
                    updateClaimForSub<Saml2Config>(connection);
                }
                catch (Exception ex)
                {
                    Log.Logger.Error(ex, "Warning");
                }
            }
        }

        private static void updateClaimForSub<T>(SqlConnection connection) where T : new()
        {
            var externalProviders = connection.Query<ExternalProvider>(
                $"select * from [dbo].[externalProviders] where type = '{typeof(T).Name}'");
                
            foreach (var ep in externalProviders)
            {
                T cfg = ep.GetConfiguration<T>();
                dynamic cfgDyn = cfg;
                if (string.IsNullOrEmpty(cfgDyn.ClaimForSub))
                {
                    cfgDyn.ClaimForSub = "name";
                    ep.SetConfiguration<T>(cfg);
                    connection.Execute(
                        $"update [dbo].[externalproviders] set Configuration=@Configuration where id = {ep.Id}", ep);
                }
            }
        }

        private static void MigrateOldConfigTable<T>(SqlConnection connection)
        {
            T cfg;
            try
            {
                cfg = connection.Query<T>($"select * from [dbo].[{typeof(T).Name}]").FirstOrDefault();
            }
            catch
            {
                return;
            }

            try
            {
                if (cfg != null)
                {
                    var ep = connection.Query<OldExternalProvider>(
                        $"select * from [dbo].[externalProviders] where type = '{typeof(T).Name}'").FirstOrDefault();
                        
                    if (ep != null)
                    {
                        (cfg as ProviderConfigBase).ClaimForRoles = ep.ClaimForRoles ?? (cfg as ProviderConfigBase).ClaimForRoles;
                        
                        if (typeof(T) == typeof(WindowsConfig))
                        {
                            WindowsConfig winCfg = cfg as WindowsConfig;
                            winCfg.WindowsSourceIdentifier = ep.WindowsSourceIdentifier ?? winCfg.WindowsSourceIdentifier;
                            winCfg.WindowsRole = ep.WindowsRole ?? winCfg.WindowsRole;
                        }
                        
                        ep.SetConfiguration<T>(cfg);
                        connection.Execute(
                            $"update [dbo].[externalproviders] set Configuration=@Configuration where type = '{typeof(T).Name}'", ep);
                    }
                }
                connection.Execute($"drop table [dbo].[{typeof(T).Name}]");
            }
            catch (Exception ex)
            {
                Log.Logger.Error(ex, "Warning");
            }
        }

        private static void EnsurePublicAddress(Microsoft.Extensions.Logging.ILogger logger, ConfigurationDbContext context, string publicAddress, bool isDevelopmentMode)
        {
            var query = context.Clients
                .Include(x => x.PostLogoutRedirectUris)
                .Include(x => x.RedirectUris);
                
            logger.LogInformation($"URLS Redirections are updating to public address {publicAddress}...");
            UriBuilder publicUri = new UriBuilder(publicAddress);
            
            foreach (var client in query)
            {
                if (client.FrontChannelLogoutUri != null)
                {
                    client.FrontChannelLogoutUri = UpdateUri(client.FrontChannelLogoutUri, publicUri, isDevelopmentMode);
                }
                foreach (var redir in client.RedirectUris)
                {
                    redir.RedirectUri = UpdateUri(redir.RedirectUri, publicUri, isDevelopmentMode);
                }
                foreach (var redir in client.PostLogoutRedirectUris)
                {
                    redir.PostLogoutRedirectUri = UpdateUri(redir.PostLogoutRedirectUri, publicUri, isDevelopmentMode);
                }
            }
            context.SaveChanges();
        }

        private static string UpdateUri(string uri, UriBuilder publicUri, bool isDevelopmentMode)
        {
            UriBuilder url = new UriBuilder(uri)
            {
                Port = publicUri.Port,
                Host = publicUri.Host,
                Scheme = publicUri.Scheme
            };
            
            if (url.Port == 80 || url.Port == 443)
            {
                url.Port = -1;
            }
            
            if (isDevelopmentMode && string.Compare(url.Path, "/authentication/login-callback", true) == 0)
            {
                return uri;
            }
            
            return url.ToString();
        }

        private static void EnsureSeedData(Microsoft.Extensions.Logging.ILogger logger, IClusterConfiguration serverConfigurations, ApplicationDbContext uasContext, ConfigurationDbContext configurationStoreContext, ICryptoService cryptoService)
        {
            logger.LogInformation("Seeding database...");
            
            logger.LogInformation("Updating AccessTokens...");
            foreach (var user in DefaultConfiguration.GetAccessTokens(cryptoService))
            {
                if (uasContext.AccessTokens.FirstOrDefault(a => a.TokenName == user.TokenName) == null)
                {
                    uasContext.AccessTokens.Add(user);
                }
            }
            
            logger.LogInformation("Updating Clients...");
            foreach (var client in DefaultConfiguration.GetClients(serverConfigurations.RuntimeClusterSettings))
            {
                if (configurationStoreContext.Clients.FirstOrDefault(a => a.ClientId == client.ClientId) == null)
                {
                    var c = client.ToEntity();
                    c.NonEditable = true;
                    configurationStoreContext.Clients.Add(c);
                }
            }
            
            logger.LogInformation("Updating Scope...");
            foreach (var scope in DefaultConfiguration.GetApiScopes())
            {
                if (configurationStoreContext.ApiScopes.FirstOrDefault(a => a.Name == scope.Name) == null)
                {
                    configurationStoreContext.ApiScopes.Add(scope.ToEntity());
                }
            }
            
            logger.LogInformation("Updating IdentityResources...");
            foreach (var resource in DefaultConfiguration.GetIdentityResources())
            {
                if (configurationStoreContext.IdentityResources.FirstOrDefault(a => a.Name == resource.Name) == null)
                {
                    configurationStoreContext.IdentityResources.Add(resource.ToEntity());
                }
            }
            
            logger.LogInformation("Updating ApiResources...");
            foreach (var resource in DefaultConfiguration.GetApiResources().ToList())
            {
                if (configurationStoreContext.ApiResources.FirstOrDefault(a => a.Name == resource.Name) == null)
                {
                    configurationStoreContext.ApiResources.Add(resource.ToEntity());
                }
            }
            
            configurationStoreContext.SaveChanges();
        }

        private static void EnsureSeedData(Microsoft.Extensions.Logging.ILogger logger, ApplicationDbContext uasContext)
        {
            logger.LogInformation("Updating External Providers...");
            
            foreach (var externalProvider in DefaultConfiguration.GetExternalProviders())
            {
                if (uasContext.ExternalProviders.FirstOrDefault(a => a.AuthenticationScheme == externalProvider.AuthenticationScheme) == null)
                {
                    uasContext.ExternalProviders.Add(externalProvider);
                }
            }
            
            uasContext.SaveChanges();
        }
    }
}
