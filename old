        async Task<IHttpActionResult> ExecuteCodeMacroMega(oDataAll data)
        {
            List<string> strerror = new List<string>();
            strerror.Add("step1");
            var guid = Guid.NewGuid().ToString().Substring(0, 2);
            var ValidateOData = ValidateODataAll(data);
            try
            {
                string startTime = $"{DateTime.Now:HH.mm.ss}";
                string endTime = null;
                var url = base.Url.Request.RequestUri.AbsolutePath.ToString();
                url = url.Split('/').LastOrDefault();
                string macroResult = "";

                var path = $"C:\\LogSerilog/{DateTime.Now:ddMMyyyy-HH.mm}_{data.Class}_u_{url}_Day_{data.DaysInterval}_{guid}.log";
                var logger = new LoggerConfiguration()
                                    .WriteTo.File(encoding: Encoding.UTF8, path: path)
                                    .CreateLogger();
                try
                {
                    string jsonReq = null;

                    try
                    {
                        #region ValidJSon
                        jsonReq = JsonConvert.SerializeObject(data);

                        #endregion
                    }
                    catch (Exception ex)
                    {
                        Log.Error($"BadRequest:{ex.Message}");
                        if (jsonReq == null)
                        {
                            return ServerError500(new WebServiceResult { ErrorType = "BadRequest", Content = ex.Message });

                        }
                    }
                    data.un = User.Identity.Name;
                    logger.Information($"UserName: {data.un}");
                    logger.Information($"url: {url}");
                    logger.Information($"Request: {jsonReq}");
                    data.ip = ((HttpContextWrapper)Request.Properties["MS_HttpContext"]).Request.UserHostAddress;
                    string sessionMode = "MS"; string accessMode = "RW"; bool closeSession = false;

                    var userInfo = getUserInfo();
                    var hopexContext = getHopexContext();
                    string mwasUrl = "";

                    var sspUrl = ConfigurationManager.AppSettings["MegaSiteProvider"];
                    var securityKey = ((NameValueCollection)WebConfigurationManager.GetSection("secureAppSettings"))["SecurityKey"];
                    int quantityDemand = 2;

                    if (!ValidateOData.IsValid)
                    {
                        logger.Error("errorValidData: " + ValidateOData.ErrorMessage);
                        return ServerError500(new WebServiceResult { ErrorType = "BadRequest", Content = ValidateOData.ErrorMessage });
                    }
                    while (quantityDemand > 0)
                    {
                        try
                        {
                            if (quantityDemand == 0)
                            {
                                return ServerError500(new WebServiceResult { ErrorType = "BadRequest", Content = "local repeat was not successful" });
                            }
                            try
                            {
                                mwasUrl = HopexService.FindSession(sspUrl, securityKey, hopexContext.EnvironmentId, hopexContext.DataLanguageId, hopexContext.GuiLanguageId, hopexContext.ProfileId, userInfo.HopexAuthPerson, true);
                            }
                            catch (Exception ex)
                            {
                                logger.Error($"ExceptionFindSession: {ex.Message}");
                                //Logger.Debug("ErrorMega: " + ex.Message);
                                return ServerError500(new WebServiceResult { ErrorType = "BadRequest", Content = JsonConvert.SerializeObject(ex) });
                            }
                            if (mwasUrl == null)
                            {
                                const string message = "Unable to get MWAS url. Please retry later and check your configuration if it doesn't work.";
                                logger.Error(message);

                                return FormatResult(new WebServiceResult { ErrorType = "BadRequest", Content = message });
                            }
                            if (mwasUrl.ToString().IndexOf("Error") > 0)
                            {
                                const string message = "Unable to get MWAS url. Please retry later and check your configuration if it doesn't work.";
                                logger.Error(message);

                                return FormatResult(new WebServiceResult { ErrorType = "BadRequest", Content = message });
                            }

                            mwasUrl = mwasUrl.ToLower().Replace("hopexmwas", "hopexapimwas");

                            // Open the Hopex session
                            var hopexService = new HopexService(mwasUrl, securityKey);
                            var mwasSettings = InitMwasSettings();
                            var mwasSessionConnectionParameters = InitMwasSessionConnectionParameters(sessionMode, accessMode, hopexContext, userInfo);
                            if (!hopexService.TryOpenSession(mwasSettings, mwasSessionConnectionParameters, findSession: !closeSession))
                            {
                                var message = "Unable to open an Hopex session. Please check the values in the HopexContext header and retry.";
                                //Logger.Debug(message);
                                return FormatResult(new WebServiceResult { ErrorType = "BadRequest", Content = message });
                            }

                            var jsmod = JsonConvert.SerializeObject(data);

                            macroResult = hopexService.CallMacro(data.MacrosID, jsmod);

                            if (data.Verb == "Read")
                            {
                                hopexService.CloseSession();
                            }
                            else
                            {
                                hopexService.CloseUpdateSession();
                            }
                            macroResult = DecoderMegaWrapper.Execute(macroResult);
                        }
                        catch (Exception exlog)
                        {
                            logger.Error($"Exception: {exlog.Message}");
                            if (exlog.Message.Contains("Response status code does not indicate success"))
                            {
                                quantityDemand--;
                                continue;
                            }
                        }
                        break;
                    }
                }
                catch (Exception exlog)
                {
                    if (!ValidateOData.IsValid)
                    {
                        logger.Error($"Exception: {ValidateOData.ErrorMessage}");
                    }
                    logger.Error($"Exception: {exlog.Message}");

                }
                finally
                {
                    endTime = $"{DateTime.Now:HH.mm.ss}";
                    logger.Information($"startTime: {startTime}");
                    logger.Information($"endTime: {endTime}");
                    logger.Information($"Response: {macroResult}");
                    logger.Dispose();

                }
                return FormatResult(new WebServiceResult { ErrorType = "None", Content = macroResult });
            }
            catch (Exception globalEx)
            {
                var stream = HttpContext.Current.Request.InputStream;//.Clear();
                var ContentLength = HttpContext.Current.Request.ContentLength;//.Clear();
                stream.Position = 0;
                string Content = "";
                using (StreamReader reader = new StreamReader(stream, encoding: Encoding.UTF8, true, 1024, true))
                {
                    Content = reader.ReadToEnd();
                    stream.Position = 0;
                }
                var body = Request.ToString();
                var path1 = $"C:\\LogSerilog/{DateTime.Now:ddMMyyyy-HH.mm}_EX_{guid}.log";
                var loggerEX = new LoggerConfiguration()
                                    .WriteTo.File(encoding: Encoding.UTF8, path: path1)
                                    .CreateLogger();

                if (ValidateOData.IsValid == false)
                {
                    loggerEX.Error($"ExceptionGl: {ValidateOData.ErrorMessage}");
                }
                loggerEX.Error($"globalEx:{globalEx.Message}");
                loggerEX.Error($"innerEx:{globalEx.InnerException}");
                loggerEX.Error($"Content: {Content}");
                loggerEX.Error($"ContentLength: {ContentLength}");
                loggerEX.Error($"bodyH: {body}");
                loggerEX.Dispose();
                return FormatResult(new WebServiceResult { ErrorType = "BadRequest", Content = globalEx.Message });
            }

        }
