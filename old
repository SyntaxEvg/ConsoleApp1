public function handle_adfs_callback() {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –Ω–∞—à callback endpoint
        if (strpos($_SERVER['REQUEST_URI'], '/adfs-callback/') === false) {
            return;
        }
        
        error_log('========================================');
        error_log('ADFS: –ü–æ–ª—É—á–µ–Ω callback –æ—Ç ADFS');
        error_log('ADFS: REQUEST_URI: ' . $_SERVER['REQUEST_URI']);
        error_log('ADFS: –í—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã GET: ' . print_r($_GET, true));
        error_log('========================================');
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–∫–∏ –æ—Ç ADFS
        if (isset($_GET['error'])) {
            $error_code = sanitize_text_field($_GET['error']);
            $error_description = isset($_GET['error_description']) ? sanitize_text_field($_GET['error_description']) : '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è';
            $error_uri = isset($_GET['error_uri']) ? esc_url_raw($_GET['error_uri']) : '';
            
            error_log('ADFS: ‚ùå –ü–æ–ª—É—á–µ–Ω–∞ –æ—à–∏–±–∫–∞ –æ—Ç ADFS!');
            error_log('ADFS: Error: ' . $error_code);
            error_log('ADFS: Description: ' . $error_description);
            
            // –ö—Ä–∞—Å–∏–≤—ã–π –≤—ã–≤–æ–¥ –æ—à–∏–±–∫–∏
            wp_die(
                '<div style="max-width: 800px; margin: 50px auto; padding: 30px; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">' .
                '<h1 style="color: #dc3545; margin-top: 0;">‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ ADFS</h1>' .
                '<div style="background: #f8d7da; border: 1px solid #f5c6cb; padding: 15px; border-radius: 4px; margin: 20px 0;">' .
                '<p style="margin: 0;"><strong>–ö–æ–¥ –æ—à–∏–±–∫–∏:</strong> <code>' . esc_html($error_code) . '</code></p>' .
                '</div>' .
                '<div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 4px; margin: 20px 0;">' .
                '<p style="margin: 0;"><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong></p>' .
                '<p style="margin: 10px 0 0 0;">' . esc_html($error_description) . '</p>' .
                '</div>' .
                ($error_uri ? '<p><strong>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</strong> <a href="' . esc_url($error_uri) . '" target="_blank">' . esc_html($error_uri) . '</a></p>' : '') .
                '<hr style="margin: 30px 0;">' .
                '<details style="margin: 20px 0;">' .
                '<summary style="cursor: pointer; color: #0073aa; font-weight: bold;">üîç –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏</summary>' .
                '<pre style="background: #f5f5f5; padding: 15px; overflow: auto; border-radius: 4px; margin-top: 10px;">' . print_r($_GET, true) . '</pre>' .
                '</details>' .
                '<div style="margin-top: 30px; text-align: center;">' .
                '<a href="' . wp_login_url() . '" class="button button-primary" style="padding: 10px 20px; font-size: 14px;">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞</a>' .
                '</div>' .
                '</div>',
                '–û—à–∏–±–∫–∞ ADFS',
                array('response' => 400)
            );
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–æ–¥–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        if (!isset($_GET['code'])) {
            error_log('ADFS: ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∫–æ–¥ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏!');
            
            wp_die(
                '<div style="max-width: 800px; margin: 50px auto; padding: 30px; background: white; border-radius: 8px;">' .
                '<h1 style="color: #dc3545;">‚ùå –û—à–∏–±–∫–∞</h1>' .
                '<p>–ù–µ –ø–æ–ª—É—á–µ–Ω –∫–æ–¥ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –æ—Ç ADFS.</p>' .
                '<details><summary>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞</summary>' .
                '<pre style="background: #f5f5f5; padding: 10px;">' . print_r($_GET, true) . '</pre>' .
                '</details>' .
                '<p><a href="' . wp_login_url() . '">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è</a></p>' .
                '</div>'
            );
        }
        
        if (!isset($_GET['state'])) {
            error_log('ADFS: ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç state –ø–∞—Ä–∞–º–µ—Ç—Ä!');
            
            wp_die(
                '<div style="max-width: 800px; margin: 50px auto; padding: 30px; background: white;">' .
                '<h1 style="color: #dc3545;">‚ùå –û—à–∏–±–∫–∞</h1>' .
                '<p>–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç state –ø–∞—Ä–∞–º–µ—Ç—Ä. –í–æ–∑–º–æ–∂–Ω–∞—è CSRF –∞—Ç–∞–∫–∞.</p>' .
                '<p><a href="' . wp_login_url() . '">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è</a></p>' .
                '</div>'
            );
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º state –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç CSRF
        if (!wp_verify_nonce($_GET['state'], 'adfs_login_state')) {
            error_log('ADFS: ‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π state! –í–æ–∑–º–æ–∂–Ω–∞—è CSRF –∞—Ç–∞–∫–∞!');
            error_log('ADFS: –ü–æ–ª—É—á–µ–Ω–Ω—ã–π state: ' . $_GET['state']);
            
            wp_die(
                '<div style="max-width: 800px; margin: 50px auto; padding: 30px; background: white;">' .
                '<h1 style="color: #dc3545;">üîí –û—à–∏–±–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏</h1>' .
                '<p>–ù–µ–≤–µ—Ä–Ω—ã–π state –ø–∞—Ä–∞–º–µ—Ç—Ä. –í–æ–∑–º–æ–∂–Ω–∞—è CSRF –∞—Ç–∞–∫–∞.</p>' .
                '<p><strong>State:</strong> <code>' . esc_html($_GET['state']) . '</code></p>' .
                '<p><a href="' . wp_login_url() . '">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è</a></p>' .
                '</div>'
            );
        }
        
        $code = sanitize_text_field($_GET['code']);
        
        error_log('ADFS: ‚úì State –ø—Ä–æ–≤–µ—Ä–µ–Ω —É—Å–ø–µ—à–Ω–æ');
        error_log('ADFS: Authorization code –ø–æ–ª—É—á–µ–Ω: ' . substr($code, 0, 30) . '...');
        
        // –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω
        $token_data = ADFS_SSO_Auth::get_access_token($code);
        
        if (is_wp_error($token_data)) {
            error_log('ADFS: ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ç–æ–∫–µ–Ω–∞!');
            
            // –ü–æ–ª—É—á–∞–µ–º –ª–æ–≥–∏
            $logs = @file_get_contents('/var/log/php-fpm/www-error.log');
            $adfs_logs = '';
            if ($logs) {
                $lines = explode("\n", $logs);
                $adfs_lines = array_filter($lines, function($line) {
                    return stripos($line, 'ADFS') !== false;
                });
                $adfs_logs = implode("\n", array_slice($adfs_lines, -30));
            }
            
            wp_die(
                '<div style="max-width: 900px; margin: 50px auto; padding: 30px; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">' .
                '<h1 style="color: #dc3545; margin-top: 0;">‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞</h1>' .
                '<div style="background: #f8d7da; border-left: 4px solid #dc3545; padding: 15px; margin: 20px 0;">' .
                '<p style="margin: 0;"><strong>–ö–æ–¥ –æ—à–∏–±–∫–∏:</strong> <code>' . esc_html($token_data->get_error_code()) . '</code></p>' .
                '</div>' .
                '<div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin: 20px 0;">' .
                '<p style="margin: 0;"><strong>–°–æ–æ–±—â–µ–Ω–∏–µ:</strong></p>' .
                '<p style="margin: 10px 0 0 0;">' . esc_html($token_data->get_error_message()) . '</p>' .
                '</div>' .
                '<details style="margin: 20px 0;"><summary style="cursor: pointer; font-weight: bold; color: #0073aa;">üìã –õ–æ–≥–∏ ADFS (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 —Å—Ç—Ä–æ–∫)</summary>' .
                '<pre style="background: #2c3e50; color: #ecf0f1; padding: 15px; overflow: auto; max-height: 400px; border-radius: 4px; margin-top: 10px; font-size: 12px;">' . 
                esc_html($adfs_logs ? $adfs_logs : '–õ–æ–≥–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã') . 
                '</pre></details>' .
                '<div style="margin-top: 30px; text-align: center;">' .
                '<a href="' . wp_login_url() . '" class="button button-primary" style="padding: 10px 20px;">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞</a>' .
                '</div>' .
                '</div>',
                '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ ADFS',
                array('response' => 500)
            );
        }
        
        error_log('ADFS: ‚úì Access token –ø–æ–ª—É—á–µ–Ω —É—Å–ø–µ—à–Ω–æ');
        
        // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
        $user_info = ADFS_SSO_Auth::get_user_info($token_data['access_token']);
        
        if (is_wp_error($user_info)) {
            error_log('ADFS: ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è!');
            
            // –ü–æ–ª—É—á–∞–µ–º –ª–æ–≥–∏
            $logs = @file_get_contents('/var/log/php-fpm/www-error.log');
            $adfs_logs = '';
            if ($logs) {
                $lines = explode("\n", $logs);
                $adfs_lines = array_filter($lines, function($line) {
                    return stripos($line, 'ADFS') !== false;
                });
                $adfs_logs = implode("\n", array_slice($adfs_lines, -30));
            }
            
            wp_die(
                '<div style="max-width: 900px; margin: 50px auto; padding: 30px; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">' .
                '<h1 style="color: #dc3545; margin-top: 0;">‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h1>' .
                '<div style="background: #f8d7da; border-left: 4px solid #dc3545; padding: 15px; margin: 20px 0;">' .
                '<p style="margin: 0;"><strong>–ö–æ–¥ –æ—à–∏–±–∫–∏:</strong> <code>' . esc_html($user_info->get_error_code()) . '</code></p>' .
                '</div>' .
                '<div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin: 20px 0;">' .
                '<p style="margin: 0;"><strong>–°–æ–æ–±—â–µ–Ω–∏–µ:</strong></p>' .
                '<p style="margin: 10px 0 0 0;">' . esc_html($user_info->get_error_message()) . '</p>' .
                '</div>' .
                '<details style="margin: 20px 0;"><summary style="cursor: pointer; font-weight: bold; color: #0073aa;">üîë Access Token (–ø–µ—Ä–≤—ã–µ 50 —Å–∏–º–≤–æ–ª–æ–≤)</summary>' .
                '<code style="display: block; background: #f5f5f5; padding: 10px; margin-top: 10px; word-break: break-all;">' . 
                esc_html(substr($token_data['access_token'], 0, 50)) . '...' .
                '</code></details>' .
                '<details style="margin: 20px 0;"><summary style="cursor: pointer; font-weight: bold; color: #0073aa;">üìã –õ–æ–≥–∏ ADFS (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 —Å—Ç—Ä–æ–∫)</summary>' .
                '<pre style="background: #2c3e50; color: #ecf0f1; padding: 15px; overflow: auto; max-height: 400px; border-radius: 4px; margin-top: 10px; font-size: 12px;">' . 
                esc_html($adfs_logs ? $adfs_logs : '–õ–æ–≥–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã') . 
                '</pre></details>' .
                '<div style="margin-top: 30px; text-align: center;">' .
                '<a href="' . wp_login_url() . '" class="button button-primary" style="padding: 10px 20px;">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞</a>' .
                '</div>' .
                '</div>',
                '–û—à–∏–±–∫–∞ ADFS UserInfo',
                array('response' => 500)
            );
        }
        
        error_log('ADFS: ‚úì –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ–ª—É—á–µ–Ω—ã');
        error_log('ADFS: Email: ' . ($user_info['email'] ?? '–ù–ï–¢'));
        
        // –°–æ–∑–¥–∞—ë–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è WordPress
        $user = $this->create_or_update_user($user_info);
        
        if (is_wp_error($user)) {
            error_log('ADFS: ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è!');
            
            wp_die(
                '<div style="max-width: 800px; margin: 50px auto; padding: 30px; background: white;">' .
                '<h1 style="color: #dc3545;">‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h1>' .
                '<p><strong>–ö–æ–¥:</strong> ' . esc_html($user->get_error_code()) . '</p>' .
                '<p><strong>–°–æ–æ–±—â–µ–Ω–∏–µ:</strong> ' . esc_html($user->get_error_message()) . '</p>' .
                '<details><summary>–î–∞–Ω–Ω—ã–µ –æ—Ç ADFS</summary>' .
                '<pre style="background: #f5f5f5; padding: 10px;">' . print_r($user_info, true) . '</pre>' .
                '</details>' .
                '<p><a href="' . wp_login_url() . '">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è</a></p>' .
                '</div>'
            );
        }
        
        error_log('ADFS: ‚úì –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω/–æ–±–Ω–æ–≤–ª—ë–Ω: ' . $user->user_login);
        
        // –ê–≤—Ç–æ—Ä–∏–∑—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        wp_set_current_user($user->ID);
        wp_set_auth_cookie($user->ID, true);
        do_action('wp_login', $user->user_login, $user);
        
        error_log('ADFS: ‚úì –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω!');
        error_log('========================================');
        
        // –†–µ–¥–∏—Ä–µ–∫—Ç –≤ –∞–¥–º–∏–Ω–∫—É
        wp_safe_redirect(admin_url());
        exit;
    }
