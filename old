# wp-crawler.ps1
# Скрипт для обхода всех страниц WordPress сайта

param(
    [string]$SiteUrl = "http://10.13.20.51",
    [string]$OutputFile = "crawl_results.txt"
)

# Игнорируем SSL ошибки если есть
add-type @"
using System.Net;
using System.Security.Cryptography.X509Certificates;
public class TrustAllCertsPolicy : ICertificatePolicy {
    public bool CheckValidationResult(
        ServicePoint srvPoint, X509Certificate certificate,
        WebRequest request, int certificateProblem) {
        return true;
    }
}
"@
[System.Net.ServicePointManager]::CertificatePolicy = New-Object TrustAllCertsPolicy

$visited = @{}
$toVisit = [System.Collections.Queue]::new()
$errors = @()

$toVisit.Enqueue($SiteUrl)
$visited[$SiteUrl] = $true

Write-Host "Начинаю обход сайта: $SiteUrl" -ForegroundColor Cyan
Write-Host "=" * 50

$count = 0

while ($toVisit.Count -gt 0) {
    $url = $toVisit.Dequeue()
    $count++
    
    Write-Host "[$count] $url" -NoNewline
    
    try {
        $response = Invoke-WebRequest -Uri $url -UseBasicParsing -TimeoutSec 30 -ErrorAction Stop
        $statusCode = $response.StatusCode
        
        if ($statusCode -eq 200) {
            Write-Host " [OK]" -ForegroundColor Green
        } else {
            Write-Host " [$statusCode]" -ForegroundColor Yellow
            $errors += "[$statusCode] $url"
        }
        
        # Ищем ссылки на страницы того же домена
        $links = $response.Links | Where-Object { $_.href -match "^(/|$SiteUrl)" } | ForEach-Object {
            if ($_.href -match "^/") {
                "$SiteUrl$($_.href)"
            } else {
                $_.href
            }
        }
        
        foreach ($link in $links) {
            # Очищаем URL от якорей и параметров
            $cleanUrl = $link -replace '#.*$', '' -replace '\?.*$', ''
            
            # Пропускаем файлы, админку и уже посещённые
            if ($cleanUrl -and 
                -not $visited.ContainsKey($cleanUrl) -and
                $cleanUrl -notmatch '\.(jpg|jpeg|png|gif|css|js|pdf|zip|woff|svg|ico)$' -and
                $cleanUrl -notmatch '/wp-admin/' -and
                $cleanUrl -notmatch '/wp-login' -and
                $cleanUrl -notmatch '/feed/' -and
                $cleanUrl -match "^$([regex]::Escape($SiteUrl))") {
                
                $visited[$cleanUrl] = $true
                $toVisit.Enqueue($cleanUrl)
            }
        }
        
    } catch {
        $errorMsg = $_.Exception.Message
        Write-Host " [ERROR: $errorMsg]" -ForegroundColor Red
        $errors += "[ERROR] $url - $errorMsg"
    }
    
    # Небольшая пауза чтобы не нагружать сервер
    Start-Sleep -Milliseconds 100
}

Write-Host ""
Write-Host "=" * 50
Write-Host "Обход завершён. Всего страниц: $count" -ForegroundColor Cyan

if ($errors.Count -gt 0) {
    Write-Host "Ошибок: $($errors.Count)" -ForegroundColor Red
    $errors | Out-File -FilePath $OutputFile -Encoding UTF8
    Write-Host "Ошибки сохранены в: $OutputFile"
} else {
    Write-Host "Ошибок не найдено!" -ForegroundColor Green
}

.\wp-crawler.ps1 -SiteUrl "http://10.13.20.51"
