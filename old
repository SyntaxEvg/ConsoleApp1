using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.Linq;
using System.Linq.Expressions;
using System.Runtime.CompilerServices;
using System.Runtime.InteropServices;
using System.Threading;
using System.Threading.Tasks;
using HAS.Server.Commons;
using Mega.Has.Commons;
using Mega.Has.Commons.Messaging;
using Mega.Has.Commons.Security;
using Mega.Has.Modules.UAS.Areas.Admin.ViewModels;
using Mega.Has.Modules.UAS.Models;
using Mega.Has.Modules.UAS.Providers.Saml2;
using Mega.Has.Modules.UAS.Stores;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.Rendering;
using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.DependencyInjection;

namespace HAS.Modules.UAS.Areas.Admin.Controllers
{
	// Token: 0x020000DB RID: 219
	[global::Microsoft.AspNetCore.Mvc.Area("Admin")]
	[global::Microsoft.AspNetCore.Authorization.Authorize(Policy = "Administrator")]
	public class Saml2Controller : global::HAS.Modules.UAS.Areas.Admin.Controllers.BaseController
	{
		// Token: 0x06000898 RID: 2200 RVA: 0x0001AFD8 File Offset: 0x000191D8
		public Saml2Controller(global::Mega.Has.Modules.UAS.Stores.ApplicationDbContext context, global::System.IServiceProvider services, global::Mega.Has.Commons.Messaging.IEventManager eventManager)
		{
			this._context = context;
			this._services = services;
			this._eventManager = eventManager;
			this._signingBehaviors = new global::System.Collections.Generic.List<global::Microsoft.AspNetCore.Mvc.Rendering.SelectListItem>
			{
				new global::Microsoft.AspNetCore.Mvc.Rendering.SelectListItem("IfIdpWantAuthnRequestsSigned ", "IfIdpWantAuthnRequestsSigned"),
				new global::Microsoft.AspNetCore.Mvc.Rendering.SelectListItem("Always ", "Always"),
				new global::Microsoft.AspNetCore.Mvc.Rendering.SelectListItem("Never  ", "Never ")
			};
			this._signinAlgorithms = new global::System.Collections.Generic.List<global::Microsoft.AspNetCore.Mvc.Rendering.SelectListItem>
			{
				new global::Microsoft.AspNetCore.Mvc.Rendering.SelectListItem("SHA256", "SHA256"),
				new global::Microsoft.AspNetCore.Mvc.Rendering.SelectListItem("SHA512", "SHA512")
			};
			this._certificateUses = new global::System.Collections.Generic.List<global::Microsoft.AspNetCore.Mvc.Rendering.SelectListItem>
			{
				new global::Microsoft.AspNetCore.Mvc.Rendering.SelectListItem("Both", "Both"),
				new global::Microsoft.AspNetCore.Mvc.Rendering.SelectListItem("Signing ", "Signing"),
				new global::Microsoft.AspNetCore.Mvc.Rendering.SelectListItem("Encryption ", "Encryption")
			};
			this._contactTypes = new global::System.Collections.Generic.List<global::Microsoft.AspNetCore.Mvc.Rendering.SelectListItem>
			{
				new global::Microsoft.AspNetCore.Mvc.Rendering.SelectListItem("Technical", "Technical"),
				new global::Microsoft.AspNetCore.Mvc.Rendering.SelectListItem("Support ", "Support"),
				new global::Microsoft.AspNetCore.Mvc.Rendering.SelectListItem("Administrative ", "Administrative"),
				new global::Microsoft.AspNetCore.Mvc.Rendering.SelectListItem("Billing ", "Billing"),
				new global::Microsoft.AspNetCore.Mvc.Rendering.SelectListItem("Other ", "Other")
			};
		}

		// Token: 0x06000899 RID: 2201 RVA: 0x0001B140 File Offset: 0x00019340
		public global::System.Threading.Tasks.Task<global::Microsoft.AspNetCore.Mvc.IActionResult> Index()
		{
			global::HAS.Modules.UAS.Areas.Admin.Controllers.Saml2Controller.<Index>d__9 <Index>d__;
			<Index>d__.<>t__builder = global::System.Runtime.CompilerServices.AsyncTaskMethodBuilder<global::Microsoft.AspNetCore.Mvc.IActionResult>.Create();
			<Index>d__.<>4__this = this;
			<Index>d__.<>1__state = -1;
			<Index>d__.<>t__builder.Start<global::HAS.Modules.UAS.Areas.Admin.Controllers.Saml2Controller.<Index>d__9>(ref <Index>d__);
			return <Index>d__.<>t__builder.Task;
		}

		// Token: 0x0600089A RID: 2202 RVA: 0x0001B184 File Offset: 0x00019384
		public global::Microsoft.AspNetCore.Mvc.IActionResult Edit(int? id)
		{
			global::HAS.Modules.UAS.Areas.Admin.Controllers.Saml2Controller.<>c__DisplayClass10_0 CS$<>8__locals1 = new global::HAS.Modules.UAS.Areas.Admin.Controllers.Saml2Controller.<>c__DisplayClass10_0();
			CS$<>8__locals1.id = id;
			global::Mega.Has.Modules.UAS.Areas.Admin.ViewModels.Saml2ConfigViewModel vm = new global::Mega.Has.Modules.UAS.Areas.Admin.ViewModels.Saml2ConfigViewModel
			{
				CertificateUses = this._certificateUses,
				SigninAlgorithms = this._signinAlgorithms,
				SigningBehaviors = this._signingBehaviors,
				ContactTypes = this._contactTypes
			};
			global::Mega.Has.Commons.Security.ICryptoService clusterConfig = this._services.GetRequiredService<global::Mega.Has.Commons.Security.ICryptoService>();
			global::Mega.Has.Modules.UAS.Areas.Admin.ViewModels.Saml2ConfigViewModel saml2ConfigViewModel = vm;
			string text;
			if (clusterConfig == null)
			{
				text = null;
			}
			else
			{
				global::Mega.Has.Commons.IClusterConfiguration configuration = clusterConfig.Configuration;
				if (configuration == null)
				{
					text = null;
				}
				else
				{
					global::Mega.Has.Commons.IClusterSettings runtimeClusterSettings = configuration.RuntimeClusterSettings;
					text = ((runtimeClusterSettings != null) ? runtimeClusterSettings.PublicAddress : null);
				}
			}
			saml2ConfigViewModel.PublicOrigin = text;
			if (CS$<>8__locals1.id == null)
			{
				return this.View(vm);
			}
			global::System.Linq.IQueryable<global::Mega.Has.Modules.UAS.Models.ExternalProvider> externalProviders = this._context.ExternalProviders;
			global::System.Linq.Expressions.ParameterExpression parameterExpression = global::System.Linq.Expressions.Expression.Parameter(typeof(global::Mega.Has.Modules.UAS.Models.ExternalProvider), "x");
			global::Mega.Has.Modules.UAS.Models.ExternalProvider provider = externalProviders.FirstOrDefault(global::System.Linq.Expressions.Expression.Lambda<global::System.Func<global::Mega.Has.Modules.UAS.Models.ExternalProvider, bool>>(global::System.Linq.Expressions.Expression.Equal(global::System.Linq.Expressions.Expression.Convert(global::System.Linq.Expressions.Expression.Property(parameterExpression, methodof(global::Mega.Has.Modules.UAS.Models.ExternalProvider.get_Id())), typeof(int?)), global::System.Linq.Expressions.Expression.Field(global::System.Linq.Expressions.Expression.Constant(CS$<>8__locals1, typeof(global::HAS.Modules.UAS.Areas.Admin.Controllers.Saml2Controller.<>c__DisplayClass10_0)), fieldof(global::HAS.Modules.UAS.Areas.Admin.Controllers.Saml2Controller.<>c__DisplayClass10_0.id))), new global::System.Linq.Expressions.ParameterExpression[] { parameterExpression }));
			if (provider == null)
			{
				return this.View(vm);
			}
			global::Mega.Has.Modules.UAS.Providers.Saml2.Saml2Config config = provider.GetConfiguration<global::Mega.Has.Modules.UAS.Providers.Saml2.Saml2Config>();
			vm.Id = provider.Id;
			vm.Enabled = provider.Enabled;
			vm.DisplayName = config.DisplayName;
			vm.CertificateUses = this._certificateUses;
			vm.SigninAlgorithms = this._signinAlgorithms;
			vm.SigningBehaviors = this._signingBehaviors;
			vm.EntityId = config.EntityId;
			vm.MetadataLocation = config.MetadataLocation;
			vm.AllowUnsolicitedAuthnResponse = config.AllowUnsolicitedAuthnResponse;
			vm.WantAssertionSigned = config.WantAssertionSigned;
			vm.WantAuthnRequestsSigned = config.WantAuthnRequestsSigned;
			vm.AuthenticateRequestSigningBehavior = config.AuthenticateRequestSigningBehavior;
			vm.CertificateName = config.CertificateName;
			vm.MinIncomingSigningAlgorithm = config.MinIncomingSigningAlgorithm;
			vm.OutboundSigningAlgorithm = config.OutboundSigningAlgorithm.ToUpper();
			vm.CertificateUse = config.CertificateUse;
			global::Mega.Has.Modules.UAS.Areas.Admin.ViewModels.Saml2ConfigViewModel saml2ConfigViewModel2 = vm;
			global::Mega.Has.Modules.UAS.Providers.Saml2.ContactPerson contactPerson = config.ContactPerson;
			saml2ConfigViewModel2.ContactEmail = ((contactPerson != null) ? contactPerson.Email : null);
			global::Mega.Has.Modules.UAS.Areas.Admin.ViewModels.Saml2ConfigViewModel saml2ConfigViewModel3 = vm;
			global::Mega.Has.Modules.UAS.Providers.Saml2.ContactPerson contactPerson2 = config.ContactPerson;
			saml2ConfigViewModel3.ContactType = ((contactPerson2 != null) ? contactPerson2.Type : null) ?? "Other";
			global::Mega.Has.Modules.UAS.Areas.Admin.ViewModels.Saml2ConfigViewModel saml2ConfigViewModel4 = vm;
			global::Mega.Has.Modules.UAS.Providers.Saml2.UasOrganization organization = config.Organization;
			saml2ConfigViewModel4.OrganizationEmail = ((organization != null) ? organization.Email : null);
			global::Mega.Has.Modules.UAS.Areas.Admin.ViewModels.Saml2ConfigViewModel saml2ConfigViewModel5 = vm;
			global::Mega.Has.Modules.UAS.Providers.Saml2.UasOrganization organization2 = config.Organization;
			saml2ConfigViewModel5.OrganizationName = ((organization2 != null) ? organization2.Name : null);
			global::Mega.Has.Modules.UAS.Areas.Admin.ViewModels.Saml2ConfigViewModel saml2ConfigViewModel6 = vm;
			global::Mega.Has.Modules.UAS.Providers.Saml2.UasOrganization organization3 = config.Organization;
			saml2ConfigViewModel6.OrganizationUrl = ((organization3 != null) ? organization3.Url : null);
			vm.ClaimForRoles = config.ClaimForRoles;
			vm.ClaimForSub = config.ClaimForSub;
			vm.ModulePath = config.ModulePath;
			vm.GroupsAuthorized = config.GroupsAuthorized;
			return this.View(vm);
		}

		// Token: 0x0600089B RID: 2203 RVA: 0x0001B444 File Offset: 0x00019644
		[global::Microsoft.AspNetCore.Mvc.HttpPost]
		public global::System.Threading.Tasks.Task<global::Microsoft.AspNetCore.Mvc.IActionResult> Edit(global::Mega.Has.Modules.UAS.Areas.Admin.ViewModels.Saml2ConfigViewModel vm)
		{
			global::HAS.Modules.UAS.Areas.Admin.Controllers.Saml2Controller.<Edit>d__11 <Edit>d__;
			<Edit>d__.<>t__builder = global::System.Runtime.CompilerServices.AsyncTaskMethodBuilder<global::Microsoft.AspNetCore.Mvc.IActionResult>.Create();
			<Edit>d__.<>4__this = this;
			<Edit>d__.vm = vm;
			<Edit>d__.<>1__state = -1;
			<Edit>d__.<>t__builder.Start<global::HAS.Modules.UAS.Areas.Admin.Controllers.Saml2Controller.<Edit>d__11>(ref <Edit>d__);
			return <Edit>d__.<>t__builder.Task;
		}

		// Token: 0x0600089C RID: 2204 RVA: 0x0001B490 File Offset: 0x00019690
		public global::Microsoft.AspNetCore.Mvc.IActionResult Delete(int id)
		{
			global::HAS.Modules.UAS.Areas.Admin.Controllers.Saml2Controller.<>c__DisplayClass12_0 CS$<>8__locals1 = new global::HAS.Modules.UAS.Areas.Admin.Controllers.Saml2Controller.<>c__DisplayClass12_0();
			CS$<>8__locals1.id = id;
			global::System.Linq.IQueryable<global::Mega.Has.Modules.UAS.Models.ExternalProvider> externalProviders = this._context.ExternalProviders;
			global::System.Linq.Expressions.ParameterExpression parameterExpression = global::System.Linq.Expressions.Expression.Parameter(typeof(global::Mega.Has.Modules.UAS.Models.ExternalProvider), "x");
			global::Mega.Has.Modules.UAS.Models.ExternalProvider provider = externalProviders.FirstOrDefault(global::System.Linq.Expressions.Expression.Lambda<global::System.Func<global::Mega.Has.Modules.UAS.Models.ExternalProvider, bool>>(global::System.Linq.Expressions.Expression.AndAlso(global::System.Linq.Expressions.Expression.Equal(global::System.Linq.Expressions.Expression.Property(parameterExpression, methodof(global::Mega.Has.Modules.UAS.Models.ExternalProvider.get_Id())), global::System.Linq.Expressions.Expression.Field(global::System.Linq.Expressions.Expression.Constant(CS$<>8__locals1, typeof(global::HAS.Modules.UAS.Areas.Admin.Controllers.Saml2Controller.<>c__DisplayClass12_0)), fieldof(global::HAS.Modules.UAS.Areas.Admin.Controllers.Saml2Controller.<>c__DisplayClass12_0.id))), global::System.Linq.Expressions.Expression.Equal(global::System.Linq.Expressions.Expression.Property(parameterExpression, methodof(global::Mega.Has.Modules.UAS.Models.ExternalProvider.get_Type())), global::System.Linq.Expressions.Expression.Constant("Saml2Config", typeof(string)))), new global::System.Linq.Expressions.ParameterExpression[] { parameterExpression }));
			if (provider == null)
			{
				return this.NotFound();
			}
			this._context.ExternalProviders.Remove(provider);
			this._context.SaveChanges();
			global::Mega.Has.Commons.Messaging.IEventManager eventManager = this._services.GetRequiredService<global::Mega.Has.Commons.Messaging.IEventManager>();
			if (eventManager != null)
			{
				eventManager.Notify("RESTART", "*", global::Mega.Has.Commons.Messaging.EventScope.Cluster);
			}
			return this.Redirect("/console/restart");
		}

		// Token: 0x040005C8 RID: 1480
		private readonly global::Mega.Has.Modules.UAS.Stores.ApplicationDbContext _context;

		// Token: 0x040005C9 RID: 1481
		private readonly global::System.IServiceProvider _services;

		// Token: 0x040005CA RID: 1482
		private readonly global::System.Collections.Generic.List<global::Microsoft.AspNetCore.Mvc.Rendering.SelectListItem> _signingBehaviors;

		// Token: 0x040005CB RID: 1483
		private readonly global::System.Collections.Generic.List<global::Microsoft.AspNetCore.Mvc.Rendering.SelectListItem> _signinAlgorithms;

		// Token: 0x040005CC RID: 1484
		private readonly global::System.Collections.Generic.List<global::Microsoft.AspNetCore.Mvc.Rendering.SelectListItem> _certificateUses;

		// Token: 0x040005CD RID: 1485
		private readonly global::System.Collections.Generic.List<global::Microsoft.AspNetCore.Mvc.Rendering.SelectListItem> _contactTypes;

		// Token: 0x040005CE RID: 1486
		private readonly global::Mega.Has.Commons.Messaging.IEventManager _eventManager;

		// Token: 0x040005CF RID: 1487
		private const string RSAUrl = "http://www.w3.org/2001/04/xmldsig-more#rsa-";

		// Token: 0x0200024F RID: 591
		[global::System.Runtime.CompilerServices.CompilerGenerated]
		[global::System.Serializable]
		private sealed class <>c
		{
			// Token: 0x04000D3E RID: 3390
			public static readonly global::HAS.Modules.UAS.Areas.Admin.Controllers.Saml2Controller.<>c <>9 = new global::HAS.Modules.UAS.Areas.Admin.Controllers.Saml2Controller.<>c();
		}

		// Token: 0x02000250 RID: 592
		[global::System.Runtime.CompilerServices.CompilerGenerated]
		private sealed class <>c__DisplayClass10_0
		{
			// Token: 0x04000D3F RID: 3391
			public int? id;
		}

		// Token: 0x02000251 RID: 593
		[global::System.Runtime.CompilerServices.CompilerGenerated]
		private sealed class <>c__DisplayClass11_0
		{
			// Token: 0x04000D40 RID: 3392
			public global::Mega.Has.Modules.UAS.Areas.Admin.ViewModels.Saml2ConfigViewModel vm;
		}

		// Token: 0x02000252 RID: 594
		[global::System.Runtime.CompilerServices.CompilerGenerated]
		private sealed class <>c__DisplayClass12_0
		{
			// Token: 0x04000D41 RID: 3393
			public int id;
		}

		// Token: 0x02000253 RID: 595
		[global::System.Runtime.CompilerServices.CompilerGenerated]
		[global::System.Runtime.InteropServices.StructLayout(global::System.Runtime.InteropServices.LayoutKind.Auto)]
		private struct <Edit>d__11 : global::System.Runtime.CompilerServices.IAsyncStateMachine
		{
			// Token: 0x06000DB7 RID: 3511 RVA: 0x0006EF3C File Offset: 0x0006D13C
			void global::System.Runtime.CompilerServices.IAsyncStateMachine.MoveNext()
			{
				int num = this.<>1__state;
				global::HAS.Modules.UAS.Areas.Admin.Controllers.Saml2Controller saml2Controller = this.<>4__this;
				global::Microsoft.AspNetCore.Mvc.IActionResult actionResult;
				try
				{
					if (num != 0)
					{
						this.<>8__1 = new global::HAS.Modules.UAS.Areas.Admin.Controllers.Saml2Controller.<>c__DisplayClass11_0();
						this.<>8__1.vm = this.vm;
						this.<>8__1.vm.CertificateUses = saml2Controller._certificateUses;
						this.<>8__1.vm.SigninAlgorithms = saml2Controller._signinAlgorithms;
						this.<>8__1.vm.SigningBehaviors = saml2Controller._signingBehaviors;
						this.<>8__1.vm.ContactTypes = saml2Controller._contactTypes;
						if (this.<>8__1.vm.Enabled && !saml2Controller.ModelState.IsValid)
						{
							actionResult = saml2Controller.View(this.<>8__1.vm);
							goto IL_0AAC;
						}
						global::System.Linq.Expressions.ParameterExpression parameterExpression;
						if (this.<>8__1.vm.Id == 0)
						{
							global::System.Linq.IQueryable<global::Mega.Has.Modules.UAS.Models.ExternalProvider> externalProviders = saml2Controller._context.ExternalProviders;
							parameterExpression = global::System.Linq.Expressions.Expression.Parameter(typeof(global::Mega.Has.Modules.UAS.Models.ExternalProvider), "e");
							if (externalProviders.FirstOrDefault(global::System.Linq.Expressions.Expression.Lambda<global::System.Func<global::Mega.Has.Modules.UAS.Models.ExternalProvider, bool>>(global::System.Linq.Expressions.Expression.Equal(global::System.Linq.Expressions.Expression.Property(parameterExpression, methodof(global::Mega.Has.Modules.UAS.Models.ExternalProvider.get_DisplayName())), global::System.Linq.Expressions.Expression.Property(global::System.Linq.Expressions.Expression.Field(global::System.Linq.Expressions.Expression.Constant(this.<>8__1, typeof(global::HAS.Modules.UAS.Areas.Admin.Controllers.Saml2Controller.<>c__DisplayClass11_0)), fieldof(global::HAS.Modules.UAS.Areas.Admin.Controllers.Saml2Controller.<>c__DisplayClass11_0.vm)), methodof(global::Mega.Has.Modules.UAS.Areas.Admin.ViewModels.Saml2ConfigViewModel.get_DisplayName()))), new global::System.Linq.Expressions.ParameterExpression[] { parameterExpression })) != null)
							{
								saml2Controller.ModelState.AddModelError("DisplayName", "Duplicate display name");
								actionResult = saml2Controller.View(this.<>8__1.vm);
								goto IL_0AAC;
							}
							this.<provider>5__3 = new global::Mega.Has.Modules.UAS.Models.ExternalProvider
							{
								Id = this.<>8__1.vm.Id,
								AuthenticationScheme = "Saml2",
								IconName = "saml2",
								Type = "Saml2Config"
							};
							saml2Controller._context.ExternalProviders.Add(this.<provider>5__3);
							this.<config>5__2 = new global::Mega.Has.Modules.UAS.Providers.Saml2.Saml2Config();
						}
						else
						{
							global::System.Linq.IQueryable<global::Mega.Has.Modules.UAS.Models.ExternalProvider> externalProviders2 = saml2Controller._context.ExternalProviders;
							parameterExpression = global::System.Linq.Expressions.Expression.Parameter(typeof(global::Mega.Has.Modules.UAS.Models.ExternalProvider), "e");
							if (externalProviders2.FirstOrDefault(global::System.Linq.Expressions.Expression.Lambda<global::System.Func<global::Mega.Has.Modules.UAS.Models.ExternalProvider, bool>>(global::System.Linq.Expressions.Expression.AndAlso(global::System.Linq.Expressions.Expression.Equal(global::System.Linq.Expressions.Expression.Property(parameterExpression, methodof(global::Mega.Has.Modules.UAS.Models.ExternalProvider.get_DisplayName())), global::System.Linq.Expressions.Expression.Property(global::System.Linq.Expressions.Expression.Field(global::System.Linq.Expressions.Expression.Constant(this.<>8__1, typeof(global::HAS.Modules.UAS.Areas.Admin.Controllers.Saml2Controller.<>c__DisplayClass11_0)), fieldof(global::HAS.Modules.UAS.Areas.Admin.Controllers.Saml2Controller.<>c__DisplayClass11_0.vm)), methodof(global::Mega.Has.Modules.UAS.Areas.Admin.ViewModels.Saml2ConfigViewModel.get_DisplayName()))), global::System.Linq.Expressions.Expression.NotEqual(global::System.Linq.Expressions.Expression.Property(parameterExpression, methodof(global::Mega.Has.Modules.UAS.Models.ExternalProvider.get_Id())), global::System.Linq.Expressions.Expression.Property(global::System.Linq.Expressions.Expression.Field(global::System.Linq.Expressions.Expression.Constant(this.<>8__1, typeof(global::HAS.Modules.UAS.Areas.Admin.Controllers.Saml2Controller.<>c__DisplayClass11_0)), fieldof(global::HAS.Modules.UAS.Areas.Admin.Controllers.Saml2Controller.<>c__DisplayClass11_0.vm)), methodof(global::Mega.Has.Modules.UAS.Areas.Admin.ViewModels.Saml2ConfigViewModel.get_Id())))), new global::System.Linq.Expressions.ParameterExpression[] { parameterExpression })) != null)
							{
								saml2Controller.ModelState.AddModelError("DisplayName", "Duplicate display name");
								actionResult = saml2Controller.View(this.<>8__1.vm);
								goto IL_0AAC;
							}
							global::System.Linq.IQueryable<global::Mega.Has.Modules.UAS.Models.ExternalProvider> externalProviders3 = saml2Controller._context.ExternalProviders;
							parameterExpression = global::System.Linq.Expressions.Expression.Parameter(typeof(global::Mega.Has.Modules.UAS.Models.ExternalProvider), "x");
							this.<provider>5__3 = externalProviders3.FirstOrDefault(global::System.Linq.Expressions.Expression.Lambda<global::System.Func<global::Mega.Has.Modules.UAS.Models.ExternalProvider, bool>>(global::System.Linq.Expressions.Expression.Equal(global::System.Linq.Expressions.Expression.Property(parameterExpression, methodof(global::Mega.Has.Modules.UAS.Models.ExternalProvider.get_Id())), global::System.Linq.Expressions.Expression.Property(global::System.Linq.Expressions.Expression.Field(global::System.Linq.Expressions.Expression.Constant(this.<>8__1, typeof(global::HAS.Modules.UAS.Areas.Admin.Controllers.Saml2Controller.<>c__DisplayClass11_0)), fieldof(global::HAS.Modules.UAS.Areas.Admin.Controllers.Saml2Controller.<>c__DisplayClass11_0.vm)), methodof(global::Mega.Has.Modules.UAS.Areas.Admin.ViewModels.Saml2ConfigViewModel.get_Id()))), new global::System.Linq.Expressions.ParameterExpression[] { parameterExpression }));
							this.<config>5__2 = this.<provider>5__3.GetConfiguration<global::Mega.Has.Modules.UAS.Providers.Saml2.Saml2Config>();
						}
						this.<config>5__2.ModulePath = this.<>8__1.vm.ModulePath;
						global::System.Linq.IQueryable<global::Mega.Has.Modules.UAS.Models.ExternalProvider> externalProviders4 = saml2Controller._context.ExternalProviders;
						parameterExpression = global::System.Linq.Expressions.Expression.Parameter(typeof(global::Mega.Has.Modules.UAS.Models.ExternalProvider), "e");
						global::System.Linq.IQueryable<global::Mega.Has.Modules.UAS.Models.ExternalProvider> entities = externalProviders4.Where(global::System.Linq.Expressions.Expression.Lambda<global::System.Func<global::Mega.Has.Modules.UAS.Models.ExternalProvider, bool>>(global::System.Linq.Expressions.Expression.AndAlso(global::System.Linq.Expressions.Expression.Equal(global::System.Linq.Expressions.Expression.Property(parameterExpression, methodof(global::Mega.Has.Modules.UAS.Models.ExternalProvider.get_Type())), global::System.Linq.Expressions.Expression.Constant("Saml2Config", typeof(string))), global::System.Linq.Expressions.Expression.NotEqual(global::System.Linq.Expressions.Expression.Property(parameterExpression, methodof(global::Mega.Has.Modules.UAS.Models.ExternalProvider.get_Id())), global::System.Linq.Expressions.Expression.Property(global::System.Linq.Expressions.Expression.Field(global::System.Linq.Expressions.Expression.Constant(this.<>8__1, typeof(global::HAS.Modules.UAS.Areas.Admin.Controllers.Saml2Controller.<>c__DisplayClass11_0)), fieldof(global::HAS.Modules.UAS.Areas.Admin.Controllers.Saml2Controller.<>c__DisplayClass11_0.vm)), methodof(global::Mega.Has.Modules.UAS.Areas.Admin.ViewModels.Saml2ConfigViewModel.get_Id())))), new global::System.Linq.Expressions.ParameterExpression[] { parameterExpression }));
						global::System.Collections.Generic.IEnumerator<global::Mega.Has.Modules.UAS.Models.ExternalProvider> enumerator = entities.GetEnumerator();
						try
						{
							while (enumerator.MoveNext())
							{
								global::Mega.Has.Modules.UAS.Models.ExternalProvider externalProvider = enumerator.Current;
								global::Mega.Has.Modules.UAS.Providers.Saml2.Saml2Config Conf = externalProvider.GetConfiguration<global::Mega.Has.Modules.UAS.Providers.Saml2.Saml2Config>();
								if (Conf.ModulePath == this.<config>5__2.ModulePath)
								{
									saml2Controller.ModelState.AddModelError("ModulePath", "Duplicate ModulePath");
									actionResult = saml2Controller.View(this.<>8__1.vm);
									goto IL_0AAC;
								}
							}
						}
						finally
						{
							if (num < 0 && enumerator != null)
							{
								enumerator.Dispose();
							}
						}
						this.<provider>5__3.Enabled = this.<>8__1.vm.Enabled;
						this.<config>5__2.DisplayName = (this.<provider>5__3.DisplayName = this.<>8__1.vm.DisplayName);
						this.<config>5__2.ClaimForRoles = this.<>8__1.vm.ClaimForRoles;
						this.<config>5__2.DisplayName = this.<>8__1.vm.DisplayName;
						this.<config>5__2.EntityId = this.<>8__1.vm.EntityId;
						this.<config>5__2.MetadataLocation = this.<>8__1.vm.MetadataLocation;
						this.<config>5__2.AllowUnsolicitedAuthnResponse = this.<>8__1.vm.AllowUnsolicitedAuthnResponse;
						this.<config>5__2.WantAssertionSigned = this.<>8__1.vm.WantAssertionSigned;
						this.<config>5__2.WantAuthnRequestsSigned = this.<>8__1.vm.WantAuthnRequestsSigned;
						this.<config>5__2.AuthenticateRequestSigningBehavior = this.<>8__1.vm.AuthenticateRequestSigningBehavior;
						this.<config>5__2.CertificateName = this.<>8__1.vm.CertificateName;
						this.<config>5__2.MinIncomingSigningAlgorithm = this.<>8__1.vm.MinIncomingSigningAlgorithm.ToLower();
						this.<config>5__2.OutboundSigningAlgorithm = this.<>8__1.vm.OutboundSigningAlgorithm;
						this.<config>5__2.CertificateUse = this.<>8__1.vm.CertificateUse;
						this.<config>5__2.ClaimForRoles = this.<>8__1.vm.ClaimForRoles;
						this.<config>5__2.ClaimForSub = this.<>8__1.vm.ClaimForSub;
						this.<config>5__2.GroupsAuthorized = this.<>8__1.vm.GroupsAuthorized;
						if (string.IsNullOrEmpty(this.<config>5__2.CertificateName))
						{
							goto IL_07A9;
						}
					}
					try
					{
						global::System.Runtime.CompilerServices.TaskAwaiter<global::System.Collections.Generic.IEnumerable<global::Mega.Has.Commons.Messaging.EventMessage>> awaiter;
						if (num != 0)
						{
							awaiter = saml2Controller._eventManager.Notify("CHECK_CERTIFICATE", new global::HAS.Server.Commons.CheckCertificateEvent
							{
								friendlyName = this.<config>5__2.CertificateName,
								Thumbprint = null
							}, global::Mega.Has.Commons.Messaging.EventScope.Cluster).GetAwaiter();
							if (!awaiter.IsCompleted)
							{
								num = (this.<>1__state = 0);
								this.<>u__1 = awaiter;
								this.<>t__builder.AwaitUnsafeOnCompleted<global::System.Runtime.CompilerServices.TaskAwaiter<global::System.Collections.Generic.IEnumerable<global::Mega.Has.Commons.Messaging.EventMessage>>, global::HAS.Modules.UAS.Areas.Admin.Controllers.Saml2Controller.<Edit>d__11>(ref awaiter, ref this);
								return;
							}
						}
						else
						{
							awaiter = this.<>u__1;
							this.<>u__1 = default(global::System.Runtime.CompilerServices.TaskAwaiter<global::System.Collections.Generic.IEnumerable<global::Mega.Has.Commons.Messaging.EventMessage>>);
							num = (this.<>1__state = -1);
						}
						awaiter.GetResult();
					}
					catch (global::System.Exception ex)
					{
						saml2Controller.ModelState.AddModelError("CertificateName", ex.Message);
						actionResult = saml2Controller.View(this.<>8__1.vm);
						goto IL_0AAC;
					}
					IL_07A9:
					if (string.IsNullOrEmpty(this.<config>5__2.ClaimForSub))
					{
						saml2Controller.ModelState.AddModelError("ClaimForSub", "ClaimForSub Is Mandatory");
						actionResult = saml2Controller.View(this.<>8__1.vm);
					}
					else
					{
						if (!string.IsNullOrEmpty(this.<>8__1.vm.ContactEmail))
						{
							if (!saml2Controller._context.ContactPerson.Any<global::Mega.Has.Modules.UAS.Providers.Saml2.ContactPerson>())
							{
								this.<config>5__2.ContactPerson = new global::Mega.Has.Modules.UAS.Providers.Saml2.ContactPerson
								{
									Email = this.<>8__1.vm.ContactEmail,
									Type = (this.<>8__1.vm.ContactType ?? "Other")
								};
							}
							else
							{
								this.<config>5__2.ContactPerson = saml2Controller._context.ContactPerson.FirstOrDefault<global::Mega.Has.Modules.UAS.Providers.Saml2.ContactPerson>();
								if (this.<config>5__2.ContactPerson != null)
								{
									this.<config>5__2.ContactPerson.Email = this.<>8__1.vm.ContactEmail;
									this.<config>5__2.ContactPerson.Type = this.<>8__1.vm.ContactType ?? "Other";
								}
							}
						}
						if (!string.IsNullOrEmpty(this.<>8__1.vm.OrganizationName))
						{
							if (saml2Controller._context.Organization.Any<global::Mega.Has.Modules.UAS.Providers.Saml2.UasOrganization>())
							{
								this.<config>5__2.Organization = new global::Mega.Has.Modules.UAS.Providers.Saml2.UasOrganization
								{
									DisplayName = this.<>8__1.vm.OrganizationName,
									Name = this.<>8__1.vm.OrganizationName,
									Email = this.<>8__1.vm.OrganizationEmail,
									Language = "en-US",
									Url = this.<>8__1.vm.OrganizationUrl
								};
							}
							else
							{
								this.<config>5__2.Organization = saml2Controller._context.Organization.FirstOrDefault<global::Mega.Has.Modules.UAS.Providers.Saml2.UasOrganization>();
								if (this.<config>5__2.Organization != null)
								{
									this.<config>5__2.Organization.DisplayName = this.<>8__1.vm.OrganizationName;
									this.<config>5__2.Organization.Name = this.<>8__1.vm.OrganizationName;
									this.<config>5__2.Organization.Email = this.<>8__1.vm.OrganizationEmail;
									this.<config>5__2.Organization.Language = "en-US";
									this.<config>5__2.Organization.Url = this.<>8__1.vm.OrganizationUrl;
								}
							}
						}
						this.<provider>5__3.SetConfiguration<global::Mega.Has.Modules.UAS.Providers.Saml2.Saml2Config>(this.<config>5__2);
						saml2Controller._context.SaveChanges();
						global::Mega.Has.Commons.Messaging.IEventManager eventManager = saml2Controller._services.GetRequiredService<global::Mega.Has.Commons.Messaging.IEventManager>();
						if (eventManager != null)
						{
							eventManager.Notify("RESTART", "*", global::Mega.Has.Commons.Messaging.EventScope.Cluster);
						}
						actionResult = saml2Controller.Redirect("/console/restart");
					}
				}
				catch (global::System.Exception ex2)
				{
					this.<>1__state = -2;
					this.<>8__1 = null;
					this.<config>5__2 = null;
					this.<provider>5__3 = null;
					this.<>t__builder.SetException(ex2);
					return;
				}
				IL_0AAC:
				this.<>1__state = -2;
				this.<>8__1 = null;
				this.<config>5__2 = null;
				this.<provider>5__3 = null;
				this.<>t__builder.SetResult(actionResult);
			}

			// Token: 0x06000DB8 RID: 3512 RVA: 0x0006FA6C File Offset: 0x0006DC6C
			[global::System.Diagnostics.DebuggerHidden]
			void global::System.Runtime.CompilerServices.IAsyncStateMachine.SetStateMachine([global::System.Runtime.CompilerServices.Nullable(1)] global::System.Runtime.CompilerServices.IAsyncStateMachine stateMachine)
			{
				this.<>t__builder.SetStateMachine(stateMachine);
			}

			// Token: 0x04000D42 RID: 3394
			public int <>1__state;

			// Token: 0x04000D43 RID: 3395
			public global::System.Runtime.CompilerServices.AsyncTaskMethodBuilder<global::Microsoft.AspNetCore.Mvc.IActionResult> <>t__builder;

			// Token: 0x04000D44 RID: 3396
			public global::Mega.Has.Modules.UAS.Areas.Admin.ViewModels.Saml2ConfigViewModel vm;

			// Token: 0x04000D45 RID: 3397
			public global::HAS.Modules.UAS.Areas.Admin.Controllers.Saml2Controller <>4__this;

			// Token: 0x04000D46 RID: 3398
			private global::HAS.Modules.UAS.Areas.Admin.Controllers.Saml2Controller.<>c__DisplayClass11_0 <>8__1;

			// Token: 0x04000D47 RID: 3399
			private global::Mega.Has.Modules.UAS.Providers.Saml2.Saml2Config <config>5__2;

			// Token: 0x04000D48 RID: 3400
			private global::Mega.Has.Modules.UAS.Models.ExternalProvider <provider>5__3;

			// Token: 0x04000D49 RID: 3401
			private global::System.Runtime.CompilerServices.TaskAwaiter<global::System.Collections.Generic.IEnumerable<global::Mega.Has.Commons.Messaging.EventMessage>> <>u__1;
		}

		// Token: 0x02000254 RID: 596
		[global::System.Runtime.CompilerServices.CompilerGenerated]
		[global::System.Runtime.InteropServices.StructLayout(global::System.Runtime.InteropServices.LayoutKind.Auto)]
		private struct <Index>d__9 : global::System.Runtime.CompilerServices.IAsyncStateMachine
		{
			// Token: 0x06000DB9 RID: 3513 RVA: 0x0006FA7C File Offset: 0x0006DC7C
			void global::System.Runtime.CompilerServices.IAsyncStateMachine.MoveNext()
			{
				int num = this.<>1__state;
				global::HAS.Modules.UAS.Areas.Admin.Controllers.Saml2Controller saml2Controller = this.<>4__this;
				global::Microsoft.AspNetCore.Mvc.IActionResult actionResult;
				try
				{
					global::System.Runtime.CompilerServices.TaskAwaiter<global::System.Collections.Generic.List<global::Mega.Has.Modules.UAS.Models.ExternalProvider>> awaiter;
					if (num != 0)
					{
						this.<list>5__2 = new global::System.Collections.Generic.List<global::Mega.Has.Modules.UAS.Areas.Admin.ViewModels.Saml2ConfigViewModel>();
						global::System.Linq.IQueryable<global::Mega.Has.Modules.UAS.Models.ExternalProvider> externalProviders = saml2Controller._context.ExternalProviders;
						global::System.Linq.Expressions.ParameterExpression parameterExpression = global::System.Linq.Expressions.Expression.Parameter(typeof(global::Mega.Has.Modules.UAS.Models.ExternalProvider), "e");
						awaiter = externalProviders.Where(global::System.Linq.Expressions.Expression.Lambda<global::System.Func<global::Mega.Has.Modules.UAS.Models.ExternalProvider, bool>>(global::System.Linq.Expressions.Expression.Equal(global::System.Linq.Expressions.Expression.Property(parameterExpression, methodof(global::Mega.Has.Modules.UAS.Models.ExternalProvider.get_Type())), global::System.Linq.Expressions.Expression.Constant("Saml2Config", typeof(string))), new global::System.Linq.Expressions.ParameterExpression[] { parameterExpression })).ToListAsync(default(global::System.Threading.CancellationToken)).GetAwaiter();
						if (!awaiter.IsCompleted)
						{
							num = (this.<>1__state = 0);
							this.<>u__1 = awaiter;
							this.<>t__builder.AwaitUnsafeOnCompleted<global::System.Runtime.CompilerServices.TaskAwaiter<global::System.Collections.Generic.List<global::Mega.Has.Modules.UAS.Models.ExternalProvider>>, global::HAS.Modules.UAS.Areas.Admin.Controllers.Saml2Controller.<Index>d__9>(ref awaiter, ref this);
							return;
						}
					}
					else
					{
						awaiter = this.<>u__1;
						this.<>u__1 = default(global::System.Runtime.CompilerServices.TaskAwaiter<global::System.Collections.Generic.List<global::Mega.Has.Modules.UAS.Models.ExternalProvider>>);
						num = (this.<>1__state = -1);
					}
					global::System.Collections.Generic.List<global::Mega.Has.Modules.UAS.Models.ExternalProvider> result = awaiter.GetResult();
					global::System.Collections.Generic.List<global::Mega.Has.Modules.UAS.Models.ExternalProvider>.Enumerator enumerator = result.GetEnumerator();
					try
					{
						while (enumerator.MoveNext())
						{
							global::Mega.Has.Modules.UAS.Models.ExternalProvider provider = enumerator.Current;
							global::Mega.Has.Modules.UAS.Providers.Saml2.Saml2Config config = provider.GetConfiguration<global::Mega.Has.Modules.UAS.Providers.Saml2.Saml2Config>();
							global::Mega.Has.Modules.UAS.Areas.Admin.ViewModels.Saml2ConfigViewModel configViewModel = new global::Mega.Has.Modules.UAS.Areas.Admin.ViewModels.Saml2ConfigViewModel
							{
								Enabled = provider.Enabled,
								DisplayName = provider.DisplayName,
								ClaimForRoles = config.ClaimForRoles,
								Id = provider.Id
							};
							global::Mega.Has.Commons.IClusterConfiguration clusterConfiguration = saml2Controller._services.GetRequiredService<global::Mega.Has.Commons.IClusterConfiguration>();
							global::Mega.Has.Modules.UAS.Areas.Admin.ViewModels.Saml2ConfigViewModel saml2ConfigViewModel = configViewModel;
							string text;
							if (clusterConfiguration == null)
							{
								text = null;
							}
							else
							{
								global::Mega.Has.Commons.IClusterSettings runtimeClusterSettings = clusterConfiguration.RuntimeClusterSettings;
								text = ((runtimeClusterSettings != null) ? runtimeClusterSettings.PublicAddress : null);
							}
							saml2ConfigViewModel.PublicOrigin = text;
							configViewModel.CertificateUses = saml2Controller._certificateUses;
							configViewModel.SigninAlgorithms = saml2Controller._signinAlgorithms;
							configViewModel.SigningBehaviors = saml2Controller._signingBehaviors;
							configViewModel.EntityId = config.EntityId;
							configViewModel.MetadataLocation = config.MetadataLocation;
							configViewModel.AllowUnsolicitedAuthnResponse = config.AllowUnsolicitedAuthnResponse;
							configViewModel.WantAssertionSigned = config.WantAssertionSigned;
							configViewModel.WantAuthnRequestsSigned = config.WantAuthnRequestsSigned;
							configViewModel.AuthenticateRequestSigningBehavior = config.AuthenticateRequestSigningBehavior;
							configViewModel.CertificateName = config.CertificateName;
							configViewModel.MinIncomingSigningAlgorithm = config.MinIncomingSigningAlgorithm;
							configViewModel.OutboundSigningAlgorithm = config.OutboundSigningAlgorithm;
							configViewModel.CertificateUse = config.CertificateUse;
							global::Mega.Has.Modules.UAS.Areas.Admin.ViewModels.Saml2ConfigViewModel saml2ConfigViewModel2 = configViewModel;
							global::Mega.Has.Modules.UAS.Providers.Saml2.ContactPerson contactPerson = config.ContactPerson;
							saml2ConfigViewModel2.ContactEmail = ((contactPerson != null) ? contactPerson.Email : null);
							global::Mega.Has.Modules.UAS.Areas.Admin.ViewModels.Saml2ConfigViewModel saml2ConfigViewModel3 = configViewModel;
							global::Mega.Has.Modules.UAS.Providers.Saml2.ContactPerson contactPerson2 = config.ContactPerson;
							saml2ConfigViewModel3.ContactType = ((contactPerson2 != null) ? contactPerson2.Type : null) ?? "Other";
							global::Mega.Has.Modules.UAS.Areas.Admin.ViewModels.Saml2ConfigViewModel saml2ConfigViewModel4 = configViewModel;
							global::Mega.Has.Modules.UAS.Providers.Saml2.UasOrganization organization = config.Organization;
							saml2ConfigViewModel4.OrganizationEmail = ((organization != null) ? organization.Email : null);
							global::Mega.Has.Modules.UAS.Areas.Admin.ViewModels.Saml2ConfigViewModel saml2ConfigViewModel5 = configViewModel;
							global::Mega.Has.Modules.UAS.Providers.Saml2.UasOrganization organization2 = config.Organization;
							saml2ConfigViewModel5.OrganizationName = ((organization2 != null) ? organization2.Name : null);
							global::Mega.Has.Modules.UAS.Areas.Admin.ViewModels.Saml2ConfigViewModel saml2ConfigViewModel6 = configViewModel;
							global::Mega.Has.Modules.UAS.Providers.Saml2.UasOrganization organization3 = config.Organization;
							saml2ConfigViewModel6.OrganizationUrl = ((organization3 != null) ? organization3.Url : null);
							configViewModel.ClaimForRoles = config.ClaimForRoles;
							configViewModel.ClaimForSub = config.ClaimForSub;
							configViewModel.ModulePath = config.ModulePath;
							configViewModel.GroupsAuthorized = config.GroupsAuthorized;
							configViewModel.OutboundSigningAlgorithm = config.OutboundSigningAlgorithm;
							this.<list>5__2.Add(configViewModel);
						}
					}
					finally
					{
						if (num < 0)
						{
							((global::System.IDisposable)enumerator).Dispose();
						}
					}
					actionResult = saml2Controller.View(this.<list>5__2);
				}
				catch (global::System.Exception ex)
				{
					this.<>1__state = -2;
					this.<list>5__2 = null;
					this.<>t__builder.SetException(ex);
					return;
				}
				this.<>1__state = -2;
				this.<list>5__2 = null;
				this.<>t__builder.SetResult(actionResult);
			}

			// Token: 0x06000DBA RID: 3514 RVA: 0x0006FE30 File Offset: 0x0006E030
			[global::System.Diagnostics.DebuggerHidden]
			void global::System.Runtime.CompilerServices.IAsyncStateMachine.SetStateMachine([global::System.Runtime.CompilerServices.Nullable(1)] global::System.Runtime.CompilerServices.IAsyncStateMachine stateMachine)
			{
				this.<>t__builder.SetStateMachine(stateMachine);
			}

			// Token: 0x04000D4A RID: 3402
			public int <>1__state;

			// Token: 0x04000D4B RID: 3403
			public global::System.Runtime.CompilerServices.AsyncTaskMethodBuilder<global::Microsoft.AspNetCore.Mvc.IActionResult> <>t__builder;

			// Token: 0x04000D4C RID: 3404
			public global::HAS.Modules.UAS.Areas.Admin.Controllers.Saml2Controller <>4__this;

			// Token: 0x04000D4D RID: 3405
			private global::System.Collections.Generic.List<global::Mega.Has.Modules.UAS.Areas.Admin.ViewModels.Saml2ConfigViewModel> <list>5__2;

			// Token: 0x04000D4E RID: 3406
			[global::System.Runtime.CompilerServices.Nullable(new byte[] { 0, 1, 0 })]
			private global::System.Runtime.CompilerServices.TaskAwaiter<global::System.Collections.Generic.List<global::Mega.Has.Modules.UAS.Models.ExternalProvider>> <>u__1;
		}
	}
}
