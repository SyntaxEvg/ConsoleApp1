using System;
using System.Collections.Generic;
using System.Collections.Specialized;
using System.Diagnostics;
using System.Linq;
using System.Runtime.CompilerServices;
using System.Runtime.InteropServices;
using System.Security.Claims;
using System.Threading.Tasks;
using System.Web;
using HAS.Modules.UAS.Exceptions;
using HAS.Modules.UAS.Extensions;
using HAS.Modules.UAS.Helpers;
using HAS.Modules.UAS.ViewModels;
using HAS.Server.Hopex.Module.Adapter.SSP.Models;
using IdentityServer4.Extensions;
using IdentityServer4.Models;
using IdentityServer4.Services;
using IdentityServer4.Stores;
using Mega.Has.Commons;
using Mega.Has.Modules.UAS.Models;
using Mega.Has.Modules.UAS.Providers.Hopex;
using Mega.Has.Modules.UAS.Providers.Windows;
using Mega.Has.Modules.UAS.Services;
using Mega.Has.Modules.UAS.ViewModels;
using Mega.Has.WebSite;
using Mega.Has.WebSite.LoginWorkflow;
using Microsoft.AspNetCore.Http;
using Microsoft.AspNetCore.Mvc.Rendering;
using Microsoft.Extensions.Localization;
using Microsoft.Extensions.Logging;

namespace HAS.Modules.UAS.Services.Factories
{
	// Token: 0x020000C2 RID: 194
	internal class ViewModelFactory : IViewModelFactory
	{
		// Token: 0x0600082C RID: 2092 RVA: 0x000186B8 File Offset: 0x000168B8
		public ViewModelFactory(IHopexSSPClient hopexSSPClient, IIdentityServerInteractionService interactionService, IExternalProviderService externalProviderService, IClusterConfiguration clusterConfiguration, IHttpContextAccessor httpContextAccessor, ILogger<ViewModelFactory> logger, IClusterAdminClient clusterAdminClient, IClientStore clientStore, IStringLocalizer<ViewModelFactory> s)
		{
			this._hopexSSPClient = hopexSSPClient;
			this._interactionService = interactionService;
			this._externalProviderService = externalProviderService;
			this._clusterConfiguration = clusterConfiguration;
			this._httpContextAccessor = httpContextAccessor;
			this._logger = logger;
			this._clusterAdminClient = clusterAdminClient;
			this._clientStore = clientStore;
			this.S = s;
		}

		// Token: 0x0600082D RID: 2093 RVA: 0x00018710 File Offset: 0x00016910
		public Task<LoggedOutViewModel> BuildLoggedOutViewModelAsync(string logoutId)
		{
			ViewModelFactory.<BuildLoggedOutViewModelAsync>d__10 <BuildLoggedOutViewModelAsync>d__;
			<BuildLoggedOutViewModelAsync>d__.<>t__builder = AsyncTaskMethodBuilder<LoggedOutViewModel>.Create();
			<BuildLoggedOutViewModelAsync>d__.<>4__this = this;
			<BuildLoggedOutViewModelAsync>d__.logoutId = logoutId;
			<BuildLoggedOutViewModelAsync>d__.<>1__state = -1;
			<BuildLoggedOutViewModelAsync>d__.<>t__builder.Start<ViewModelFactory.<BuildLoggedOutViewModelAsync>d__10>(ref <BuildLoggedOutViewModelAsync>d__);
			return <BuildLoggedOutViewModelAsync>d__.<>t__builder.Task;
		}

		// Token: 0x0600082E RID: 2094 RVA: 0x0001875C File Offset: 0x0001695C
		public Task<ValueTuple<string, LoginViewModel>> BuildLoginViewModelAsync(string returnUrl, string environmentId, bool hideModuleName = false)
		{
			ViewModelFactory.<BuildLoginViewModelAsync>d__11 <BuildLoginViewModelAsync>d__;
			<BuildLoginViewModelAsync>d__.<>t__builder = AsyncTaskMethodBuilder<ValueTuple<string, LoginViewModel>>.Create();
			<BuildLoginViewModelAsync>d__.<>4__this = this;
			<BuildLoginViewModelAsync>d__.returnUrl = returnUrl;
			<BuildLoginViewModelAsync>d__.environmentId = environmentId;
			<BuildLoginViewModelAsync>d__.hideModuleName = hideModuleName;
			<BuildLoginViewModelAsync>d__.<>1__state = -1;
			<BuildLoginViewModelAsync>d__.<>t__builder.Start<ViewModelFactory.<BuildLoginViewModelAsync>d__11>(ref <BuildLoginViewModelAsync>d__);
			return <BuildLoginViewModelAsync>d__.<>t__builder.Task;
		}

		// Token: 0x0600082F RID: 2095 RVA: 0x000187B8 File Offset: 0x000169B8
		public Task<LostPasswordViewModel> BuildLostPasswordViewModel()
		{
			ViewModelFactory.<BuildLostPasswordViewModel>d__12 <BuildLostPasswordViewModel>d__;
			<BuildLostPasswordViewModel>d__.<>t__builder = AsyncTaskMethodBuilder<LostPasswordViewModel>.Create();
			<BuildLostPasswordViewModel>d__.<>4__this = this;
			<BuildLostPasswordViewModel>d__.<>1__state = -1;
			<BuildLostPasswordViewModel>d__.<>t__builder.Start<ViewModelFactory.<BuildLostPasswordViewModel>d__12>(ref <BuildLostPasswordViewModel>d__);
			return <BuildLostPasswordViewModel>d__.<>t__builder.Task;
		}

		// Token: 0x06000830 RID: 2096 RVA: 0x000187FC File Offset: 0x000169FC
		public Task<MappingViewModel> BuildMappingViewModelAsync(string environmentId, string userName, string returnUrl, string provider, string claimForRoles, IEnumerable<Claim> claims)
		{
			ViewModelFactory.<BuildMappingViewModelAsync>d__13 <BuildMappingViewModelAsync>d__;
			<BuildMappingViewModelAsync>d__.<>t__builder = AsyncTaskMethodBuilder<MappingViewModel>.Create();
			<BuildMappingViewModelAsync>d__.<>4__this = this;
			<BuildMappingViewModelAsync>d__.environmentId = environmentId;
			<BuildMappingViewModelAsync>d__.userName = userName;
			<BuildMappingViewModelAsync>d__.returnUrl = returnUrl;
			<BuildMappingViewModelAsync>d__.provider = provider;
			<BuildMappingViewModelAsync>d__.claimForRoles = claimForRoles;
			<BuildMappingViewModelAsync>d__.claims = claims;
			<BuildMappingViewModelAsync>d__.<>1__state = -1;
			<BuildMappingViewModelAsync>d__.<>t__builder.Start<ViewModelFactory.<BuildMappingViewModelAsync>d__13>(ref <BuildMappingViewModelAsync>d__);
			return <BuildMappingViewModelAsync>d__.<>t__builder.Task;
		}

		// Token: 0x040005A1 RID: 1441
		private readonly IClientStore _clientStore;

		// Token: 0x040005A2 RID: 1442
		private readonly IClusterAdminClient _clusterAdminClient;

		// Token: 0x040005A3 RID: 1443
		private readonly IClusterConfiguration _clusterConfiguration;

		// Token: 0x040005A4 RID: 1444
		private readonly IExternalProviderService _externalProviderService;

		// Token: 0x040005A5 RID: 1445
		private readonly IHopexSSPClient _hopexSSPClient;

		// Token: 0x040005A6 RID: 1446
		private readonly IHttpContextAccessor _httpContextAccessor;

		// Token: 0x040005A7 RID: 1447
		private readonly IIdentityServerInteractionService _interactionService;

		// Token: 0x040005A8 RID: 1448
		private readonly ILogger<ViewModelFactory> _logger;

		// Token: 0x040005A9 RID: 1449
		private readonly IStringLocalizer S;

		// Token: 0x02000206 RID: 518
		[CompilerGenerated]
		[Serializable]
		private sealed class <>c
		{
			// Token: 0x06000CCF RID: 3279 RVA: 0x00065B1E File Offset: 0x00063D1E
			internal bool <BuildLoggedOutViewModelAsync>b__10_0(ExternalProvider x)
			{
				return x.AuthenticationScheme == "Hopex";
			}

			// Token: 0x06000CD0 RID: 3280 RVA: 0x00065B30 File Offset: 0x00063D30
			internal bool <BuildLoggedOutViewModelAsync>b__10_1(ExternalProvider x)
			{
				return x.Enabled && x.AuthenticationScheme != "Hopex";
			}

			// Token: 0x06000CD1 RID: 3281 RVA: 0x00065B4C File Offset: 0x00063D4C
			internal bool <BuildLoggedOutViewModelAsync>b__10_2(ExternalProvider ep)
			{
				return ep.Enabled;
			}

			// Token: 0x06000CD2 RID: 3282 RVA: 0x00065B54 File Offset: 0x00063D54
			internal bool <BuildLoginViewModelAsync>b__11_0(ExternalProvider x)
			{
				return x.AuthenticationScheme == "Hopex";
			}

			// Token: 0x06000CD3 RID: 3283 RVA: 0x00065B66 File Offset: 0x00063D66
			internal bool <BuildLoginViewModelAsync>b__11_3(ExternalProvider x)
			{
				return x.Enabled && x.AuthenticationScheme != "Hopex";
			}

			// Token: 0x06000CD4 RID: 3284 RVA: 0x00065B82 File Offset: 0x00063D82
			internal bool <BuildLoginViewModelAsync>b__11_1(ExternalProvider ep)
			{
				return ep.Enabled;
			}

			// Token: 0x06000CD5 RID: 3285 RVA: 0x00065B8A File Offset: 0x00063D8A
			internal bool <BuildLoginViewModelAsync>b__11_5(ExternalProvider c)
			{
				return c.AuthenticationScheme == "Windows";
			}

			// Token: 0x06000CD6 RID: 3286 RVA: 0x00065B9C File Offset: 0x00063D9C
			internal SelectListItem <BuildLoginViewModelAsync>b__11_2(HopexEnvironmentInfo e)
			{
				return new SelectListItem(e.Name, e.Id);
			}

			// Token: 0x06000CD7 RID: 3287 RVA: 0x00065BAF File Offset: 0x00063DAF
			internal SelectListItem <BuildLostPasswordViewModel>b__12_0(HopexEnvironmentInfo e)
			{
				return new SelectListItem(e.Name, e.Id);
			}

			// Token: 0x06000CD8 RID: 3288 RVA: 0x00065BC2 File Offset: 0x00063DC2
			internal bool <BuildMappingViewModelAsync>b__13_0(Claim c)
			{
				return c.Type == "has.repositoryid";
			}

			// Token: 0x06000CD9 RID: 3289 RVA: 0x00065BD4 File Offset: 0x00063DD4
			internal bool <BuildMappingViewModelAsync>b__13_1(Claim c)
			{
				return c.Type == "has.profileId";
			}

			// Token: 0x06000CDA RID: 3290 RVA: 0x00065BE6 File Offset: 0x00063DE6
			internal bool <BuildMappingViewModelAsync>b__13_2(Claim c)
			{
				return c.Type == "has.userId";
			}

			// Token: 0x06000CDB RID: 3291 RVA: 0x00065BF8 File Offset: 0x00063DF8
			internal bool <BuildMappingViewModelAsync>b__13_3(Claim c)
			{
				return c.Type == "has.assignableElementId";
			}

			// Token: 0x06000CDC RID: 3292 RVA: 0x00065C0A File Offset: 0x00063E0A
			internal bool <BuildMappingViewModelAsync>b__13_4(Claim c)
			{
				return c.Type == "has.dataLanguageId";
			}

			// Token: 0x06000CDD RID: 3293 RVA: 0x00065C1C File Offset: 0x00063E1C
			internal bool <BuildMappingViewModelAsync>b__13_5(Claim c)
			{
				return c.Type == "has.guiLanguageId";
			}

			// Token: 0x06000CDE RID: 3294 RVA: 0x00065C2E File Offset: 0x00063E2E
			internal bool <BuildMappingViewModelAsync>b__13_6(Claim c)
			{
				return c.Type == "has.login";
			}

			// Token: 0x06000CDF RID: 3295 RVA: 0x00065C40 File Offset: 0x00063E40
			internal SelectListItem <BuildMappingViewModelAsync>b__13_7(HopexEnvironmentInfo e)
			{
				return new SelectListItem(e.Name, e.Id);
			}

			// Token: 0x04000B9F RID: 2975
			public static readonly ViewModelFactory.<>c <>9 = new ViewModelFactory.<>c();

			// Token: 0x04000BA0 RID: 2976
			public static Func<ExternalProvider, bool> <>9__10_0;

			// Token: 0x04000BA1 RID: 2977
			public static Func<ExternalProvider, bool> <>9__10_1;

			// Token: 0x04000BA2 RID: 2978
			public static Func<ExternalProvider, bool> <>9__10_2;

			// Token: 0x04000BA3 RID: 2979
			public static Func<ExternalProvider, bool> <>9__11_0;

			// Token: 0x04000BA4 RID: 2980
			public static Func<ExternalProvider, bool> <>9__11_3;

			// Token: 0x04000BA5 RID: 2981
			public static Func<ExternalProvider, bool> <>9__11_1;

			// Token: 0x04000BA6 RID: 2982
			public static Func<ExternalProvider, bool> <>9__11_5;

			// Token: 0x04000BA7 RID: 2983
			public static Func<HopexEnvironmentInfo, SelectListItem> <>9__11_2;

			// Token: 0x04000BA8 RID: 2984
			public static Func<HopexEnvironmentInfo, SelectListItem> <>9__12_0;

			// Token: 0x04000BA9 RID: 2985
			public static Func<Claim, bool> <>9__13_0;

			// Token: 0x04000BAA RID: 2986
			public static Func<Claim, bool> <>9__13_1;

			// Token: 0x04000BAB RID: 2987
			public static Func<Claim, bool> <>9__13_2;

			// Token: 0x04000BAC RID: 2988
			public static Func<Claim, bool> <>9__13_3;

			// Token: 0x04000BAD RID: 2989
			public static Func<Claim, bool> <>9__13_4;

			// Token: 0x04000BAE RID: 2990
			public static Func<Claim, bool> <>9__13_5;

			// Token: 0x04000BAF RID: 2991
			public static Func<Claim, bool> <>9__13_6;

			// Token: 0x04000BB0 RID: 2992
			public static Func<HopexEnvironmentInfo, SelectListItem> <>9__13_7;
		}

		// Token: 0x02000207 RID: 519
		[CompilerGenerated]
		private sealed class <>c__DisplayClass11_0
		{
			// Token: 0x06000CE1 RID: 3297 RVA: 0x00065C5B File Offset: 0x00063E5B
			internal bool <BuildLoginViewModelAsync>b__4(HopexEnvironmentInfo e)
			{
				return e.Id == this.environmentId;
			}

			// Token: 0x04000BB1 RID: 2993
			public string environmentId;
		}

		// Token: 0x02000208 RID: 520
		[CompilerGenerated]
		private sealed class <>c__DisplayClass11_1
		{
			// Token: 0x06000CE3 RID: 3299 RVA: 0x00065C76 File Offset: 0x00063E76
			internal bool <BuildLoginViewModelAsync>b__6(ExternalProvider provider)
			{
				return this.client.IdentityProviderRestrictions.Contains(provider.AuthenticationScheme);
			}

			// Token: 0x04000BB2 RID: 2994
			public Client client;
		}

		// Token: 0x02000209 RID: 521
		[CompilerGenerated]
		[StructLayout(LayoutKind.Auto)]
		private struct <BuildLoggedOutViewModelAsync>d__10 : IAsyncStateMachine
		{
			// Token: 0x06000CE4 RID: 3300 RVA: 0x00065C90 File Offset: 0x00063E90
			void IAsyncStateMachine.MoveNext()
			{
				int num = this.<>1__state;
				ViewModelFactory viewModelFactory = this.<>4__this;
				LoggedOutViewModel loggedOutViewModel;
				try
				{
					TaskAwaiter<LogoutRequest> awaiter;
					TaskAwaiter<Client> awaiter2;
					TaskAwaiter<bool> awaiter3;
					TaskAwaiter<string> awaiter4;
					switch (num)
					{
					case 0:
						awaiter = this.<>u__1;
						this.<>u__1 = default(TaskAwaiter<LogoutRequest>);
						this.<>1__state = -1;
						break;
					case 1:
						awaiter2 = this.<>u__2;
						this.<>u__2 = default(TaskAwaiter<Client>);
						this.<>1__state = -1;
						goto IL_0240;
					case 2:
						awaiter3 = this.<>u__3;
						this.<>u__3 = default(TaskAwaiter<bool>);
						this.<>1__state = -1;
						goto IL_044D;
					case 3:
						awaiter4 = this.<>u__4;
						this.<>u__4 = default(TaskAwaiter<string>);
						this.<>1__state = -1;
						goto IL_04D9;
					default:
						awaiter = viewModelFactory._interactionService.GetLogoutContextAsync(this.logoutId).GetAwaiter();
						if (!awaiter.IsCompleted)
						{
							this.<>1__state = 0;
							this.<>u__1 = awaiter;
							this.<>t__builder.AwaitUnsafeOnCompleted<TaskAwaiter<LogoutRequest>, ViewModelFactory.<BuildLoggedOutViewModelAsync>d__10>(ref awaiter, ref this);
							return;
						}
						break;
					}
					LogoutRequest result = awaiter.GetResult();
					this.<logout>5__2 = result;
					if (this.<logout>5__2 == null)
					{
						throw new Exception("Logout context cannot be null.");
					}
					this.<AutomaticRedirectAfterSignOut>5__3 = AccountOptions.AutomaticRedirectAfterSignOut;
					if (this.<AutomaticRedirectAfterSignOut>5__3)
					{
						List<ExternalProvider> providers = viewModelFactory._externalProviderService.GetExternalProviders().ToList<ExternalProvider>();
						ExternalProvider hopexProvider = providers.FirstOrDefault(new Func<ExternalProvider, bool>(ViewModelFactory.<>c.<>9.<BuildLoggedOutViewModelAsync>b__10_0));
						bool hopexProviderEnabled = hopexProvider == null || hopexProvider.Enabled;
						bool flag;
						if (hopexProviderEnabled)
						{
							if (hopexProvider == null)
							{
								flag = true;
							}
							else
							{
								HopexConfig configuration = hopexProvider.GetConfiguration<HopexConfig>();
								bool? flag2 = ((configuration != null) ? new bool?(configuration.Hidden) : null);
								bool flag3 = true;
								flag = !((flag2.GetValueOrDefault() == flag3) & (flag2 != null));
							}
						}
						else
						{
							flag = false;
						}
						bool hopexProviderVisible = flag;
						IEnumerable<ExternalProvider> VisibleExternalProviders = providers.Where(new Func<ExternalProvider, bool>(ViewModelFactory.<>c.<>9.<BuildLoggedOutViewModelAsync>b__10_1));
						bool flag4;
						if (!hopexProviderEnabled)
						{
							flag4 = VisibleExternalProviders.Count(new Func<ExternalProvider, bool>(ViewModelFactory.<>c.<>9.<BuildLoggedOutViewModelAsync>b__10_2)) == 0;
						}
						else
						{
							flag4 = true;
						}
						hopexProviderEnabled = flag4;
						bool IsExternalLoginOnly = VisibleExternalProviders.Count<ExternalProvider>() == 1 && (!hopexProviderEnabled || !hopexProviderVisible);
						if (IsExternalLoginOnly)
						{
							this.<AutomaticRedirectAfterSignOut>5__3 = false;
						}
					}
					awaiter2 = viewModelFactory._clientStore.FindEnabledClientByIdAsync(this.<logout>5__2.ClientId).GetAwaiter();
					if (!awaiter2.IsCompleted)
					{
						this.<>1__state = 1;
						this.<>u__2 = awaiter2;
						this.<>t__builder.AwaitUnsafeOnCompleted<TaskAwaiter<Client>, ViewModelFactory.<BuildLoggedOutViewModelAsync>d__10>(ref awaiter2, ref this);
						return;
					}
					IL_0240:
					Client result2 = awaiter2.GetResult();
					Client client = result2;
					if (client == null)
					{
						throw new Exception("No client " + this.<logout>5__2.ClientId + " found.");
					}
					string text = (string.IsNullOrEmpty(client.Description) ? (string.IsNullOrEmpty(this.<logout>5__2.ClientName) ? this.<logout>5__2.ClientId : this.<logout>5__2.ClientName) : client.Description);
					string text2 = (string.IsNullOrEmpty(this.<logout>5__2.PostLogoutRedirectUri) ? viewModelFactory._clusterConfiguration.RuntimeClusterSettings.PublicAddress : this.<logout>5__2.PostLogoutRedirectUri);
					this.<vm>5__4 = new LoggedOutViewModel
					{
						AutomaticRedirectAfterSignOut = this.<AutomaticRedirectAfterSignOut>5__3,
						PostLogoutRedirectUri = (this.<logout>5__2.PostLogoutRedirectUri ?? viewModelFactory._clusterConfiguration.RuntimeClusterSettings.PublicAddress),
						ClientName = (client.Description ?? (string.IsNullOrEmpty(this.<logout>5__2.ClientName) ? this.<logout>5__2.ClientId : this.<logout>5__2.ClientName)),
						SignOutIframeUrl = this.<logout>5__2.SignOutIFrameUrl,
						LogoutId = this.logoutId
					};
					ClaimsPrincipal user = viewModelFactory._httpContextAccessor.HttpContext.User;
					if (user == null || !user.Identity.IsAuthenticated)
					{
						goto IL_050E;
					}
					Claim claim = viewModelFactory._httpContextAccessor.HttpContext.User.FindFirst("idp");
					this.<idp>5__5 = ((claim != null) ? claim.Value : null);
					if (this.<idp>5__5 == null || !(this.<idp>5__5 != "local"))
					{
						goto IL_0507;
					}
					awaiter3 = viewModelFactory._httpContextAccessor.HttpContext.GetSchemeSupportsSignOutAsync(this.<idp>5__5).GetAwaiter();
					if (!awaiter3.IsCompleted)
					{
						this.<>1__state = 2;
						this.<>u__3 = awaiter3;
						this.<>t__builder.AwaitUnsafeOnCompleted<TaskAwaiter<bool>, ViewModelFactory.<BuildLoggedOutViewModelAsync>d__10>(ref awaiter3, ref this);
						return;
					}
					IL_044D:
					bool result3 = awaiter3.GetResult();
					bool providerSupportsSignout = result3;
					if (!providerSupportsSignout)
					{
						goto IL_0507;
					}
					if (this.<vm>5__4.LogoutId != null)
					{
						goto IL_04F6;
					}
					this.<>7__wrap5 = this.<vm>5__4;
					awaiter4 = viewModelFactory._interactionService.CreateLogoutContextAsync().GetAwaiter();
					if (!awaiter4.IsCompleted)
					{
						this.<>1__state = 3;
						this.<>u__4 = awaiter4;
						this.<>t__builder.AwaitUnsafeOnCompleted<TaskAwaiter<string>, ViewModelFactory.<BuildLoggedOutViewModelAsync>d__10>(ref awaiter4, ref this);
						return;
					}
					IL_04D9:
					string result4 = awaiter4.GetResult();
					this.<>7__wrap5.LogoutId = result4;
					this.<>7__wrap5 = null;
					IL_04F6:
					this.<vm>5__4.ExternalAuthenticationScheme = this.<idp>5__5;
					IL_0507:
					this.<idp>5__5 = null;
					IL_050E:
					loggedOutViewModel = this.<vm>5__4;
				}
				catch (Exception ex)
				{
					this.<>1__state = -2;
					this.<logout>5__2 = null;
					this.<vm>5__4 = null;
					this.<>t__builder.SetException(ex);
					return;
				}
				this.<>1__state = -2;
				this.<logout>5__2 = null;
				this.<vm>5__4 = null;
				this.<>t__builder.SetResult(loggedOutViewModel);
			}

			// Token: 0x06000CE5 RID: 3301 RVA: 0x0006621C File Offset: 0x0006441C
			[DebuggerHidden]
			void IAsyncStateMachine.SetStateMachine([global::System.Runtime.CompilerServices.Nullable(1)] IAsyncStateMachine stateMachine)
			{
				this.<>t__builder.SetStateMachine(stateMachine);
			}

			// Token: 0x04000BB3 RID: 2995
			public int <>1__state;

			// Token: 0x04000BB4 RID: 2996
			public AsyncTaskMethodBuilder<LoggedOutViewModel> <>t__builder;

			// Token: 0x04000BB5 RID: 2997
			public ViewModelFactory <>4__this;

			// Token: 0x04000BB6 RID: 2998
			public string logoutId;

			// Token: 0x04000BB7 RID: 2999
			private LogoutRequest <logout>5__2;

			// Token: 0x04000BB8 RID: 3000
			private bool <AutomaticRedirectAfterSignOut>5__3;

			// Token: 0x04000BB9 RID: 3001
			private LoggedOutViewModel <vm>5__4;

			// Token: 0x04000BBA RID: 3002
			private TaskAwaiter<LogoutRequest> <>u__1;

			// Token: 0x04000BBB RID: 3003
			private TaskAwaiter<Client> <>u__2;

			// Token: 0x04000BBC RID: 3004
			private string <idp>5__5;

			// Token: 0x04000BBD RID: 3005
			private TaskAwaiter<bool> <>u__3;

			// Token: 0x04000BBE RID: 3006
			private LoggedOutViewModel <>7__wrap5;

			// Token: 0x04000BBF RID: 3007
			private TaskAwaiter<string> <>u__4;
		}

		// Token: 0x0200020A RID: 522
		[CompilerGenerated]
		[StructLayout(LayoutKind.Auto)]
		private struct <BuildLoginViewModelAsync>d__11 : IAsyncStateMachine
		{
			// Token: 0x06000CE6 RID: 3302 RVA: 0x0006622C File Offset: 0x0006442C
			void IAsyncStateMachine.MoveNext()
			{
				int num = this.<>1__state;
				ViewModelFactory viewModelFactory = this.<>4__this;
				ValueTuple<string, LoginViewModel> valueTuple;
				try
				{
					TaskAwaiter<string> awaiter;
					TaskAwaiter<AuthorizationRequest> awaiter2;
					TaskAwaiter<Client> awaiter4;
					switch (num)
					{
					case 0:
						awaiter = this.<>u__1;
						this.<>u__1 = default(TaskAwaiter<string>);
						num = (this.<>1__state = -1);
						break;
					case 1:
						awaiter2 = this.<>u__2;
						this.<>u__2 = default(TaskAwaiter<AuthorizationRequest>);
						num = (this.<>1__state = -1);
						goto IL_0406;
					case 2:
					{
						IL_0427:
						try
						{
							TaskAwaiter<IEnumerable<HopexEnvironmentInfo>> awaiter3;
							if (num != 2)
							{
								awaiter3 = viewModelFactory._hopexSSPClient.GetEnvironments().GetAwaiter();
								if (!awaiter3.IsCompleted)
								{
									num = (this.<>1__state = 2);
									this.<>u__3 = awaiter3;
									this.<>t__builder.AwaitUnsafeOnCompleted<TaskAwaiter<IEnumerable<HopexEnvironmentInfo>>, ViewModelFactory.<BuildLoginViewModelAsync>d__11>(ref awaiter3, ref this);
									return;
								}
							}
							else
							{
								awaiter3 = this.<>u__3;
								this.<>u__3 = default(TaskAwaiter<IEnumerable<HopexEnvironmentInfo>>);
								num = (this.<>1__state = -1);
							}
							IEnumerable<HopexEnvironmentInfo> result = awaiter3.GetResult();
							this.<environments>5__9 = result;
						}
						catch (Exception ex)
						{
							viewModelFactory._logger.LogError(ex, "Unable to log environments", Array.Empty<object>());
						}
						if (this.<environments>5__9 != null && this.<environments>5__9.Count<HopexEnvironmentInfo>() > 0)
						{
							if (this.<environments>5__9.Count<HopexEnvironmentInfo>() == 1)
							{
								this.<isEnvironmentsRequired>5__8 = true;
								this.<>8__1.environmentId = this.<environments>5__9.First<HopexEnvironmentInfo>().Id;
							}
							else
							{
								if (this.<>8__1.environmentId == null)
								{
									this.<>8__1.environmentId = viewModelFactory._httpContextAccessor.HttpContext.Request.GetLastConnectionCookie().EnvironmentId;
								}
								if (!this.<environments>5__9.Any(new Func<HopexEnvironmentInfo, bool>(this.<>8__1.<BuildLoginViewModelAsync>b__4)))
								{
									this.<>8__1.environmentId = null;
								}
							}
						}
						else
						{
							this.<environments>5__9 = null;
							if (this.<isEnvironmentsRequired>5__8)
							{
								this.<error>5__2 = "Unable to retrieve environments.";
							}
						}
						AuthorizationRequest authorizationRequest = this.<context>5__11;
						if (((authorizationRequest != null) ? authorizationRequest.Client.ClientId : null) == null)
						{
							goto IL_069F;
						}
						this.<>8__2 = new ViewModelFactory.<>c__DisplayClass11_1();
						awaiter4 = viewModelFactory._clientStore.FindEnabledClientByIdAsync(this.<context>5__11.Client.ClientId).GetAwaiter();
						if (!awaiter4.IsCompleted)
						{
							num = (this.<>1__state = 3);
							this.<>u__4 = awaiter4;
							this.<>t__builder.AwaitUnsafeOnCompleted<TaskAwaiter<Client>, ViewModelFactory.<BuildLoginViewModelAsync>d__11>(ref awaiter4, ref this);
							return;
						}
						goto IL_060F;
					}
					case 3:
						awaiter4 = this.<>u__4;
						this.<>u__4 = default(TaskAwaiter<Client>);
						num = (this.<>1__state = -1);
						goto IL_060F;
					default:
					{
						this.<>8__1 = new ViewModelFactory.<>c__DisplayClass11_0();
						this.<>8__1.environmentId = this.environmentId;
						this.<error>5__2 = string.Empty;
						this.<providers>5__3 = null;
						this.<providers>5__3 = viewModelFactory._externalProviderService.GetExternalProviders().ToList<ExternalProvider>();
						ExternalProvider hopexProvider = this.<providers>5__3.FirstOrDefault(new Func<ExternalProvider, bool>(ViewModelFactory.<>c.<>9.<BuildLoginViewModelAsync>b__11_0));
						this.<hopexProviderEnabled>5__4 = hopexProvider == null || hopexProvider.Enabled;
						bool flag;
						if (this.<hopexProviderEnabled>5__4)
						{
							if (hopexProvider == null)
							{
								flag = true;
							}
							else
							{
								HopexConfig configuration = hopexProvider.GetConfiguration<HopexConfig>();
								bool? flag2 = ((configuration != null) ? new bool?(configuration.Hidden) : null);
								bool flag3 = true;
								flag = !((flag2.GetValueOrDefault() == flag3) & (flag2 != null));
							}
						}
						else
						{
							flag = false;
						}
						this.<hopexProviderVisible>5__5 = flag;
						this.<hasNoSsoParam>5__6 = false;
						try
						{
							NameValueCollection returnUrlParameters = HttpUtility.ParseQueryString(HttpUtility.UrlDecode(this.returnUrl));
							string noSsoParam = returnUrlParameters["no_sso"];
							bool flag4;
							if (!(noSsoParam == "1") && (noSsoParam == null || !noSsoParam.Equals(bool.TrueString, StringComparison.OrdinalIgnoreCase)))
							{
								string[] values = returnUrlParameters.GetValues(null);
								flag4 = values != null && values.Contains("no_sso");
							}
							else
							{
								flag4 = true;
							}
							this.<hasNoSsoParam>5__6 = flag4;
						}
						catch (Exception ex2)
						{
						}
						this.<>7__wrap12 = new LoginViewModel();
						this.<>7__wrap12.IsInitialized = viewModelFactory._clusterConfiguration.IsInitialized;
						this.<>7__wrap11 = this.<>7__wrap12;
						awaiter = ModuleHelper.GetModuleFriendlyName(viewModelFactory._clusterAdminClient, this.returnUrl).GetAwaiter();
						if (!awaiter.IsCompleted)
						{
							num = (this.<>1__state = 0);
							this.<>u__1 = awaiter;
							this.<>t__builder.AwaitUnsafeOnCompleted<TaskAwaiter<string>, ViewModelFactory.<BuildLoginViewModelAsync>d__11>(ref awaiter, ref this);
							return;
						}
						break;
					}
					}
					string result2 = awaiter.GetResult();
					this.<>7__wrap11.ModuleFriendlyName = result2;
					this.<>7__wrap12.VisibleExternalProviders = this.<providers>5__3.Where(new Func<ExternalProvider, bool>(ViewModelFactory.<>c.<>9.<BuildLoginViewModelAsync>b__11_3));
					this.<>7__wrap12.HideFriendlyName = this.hideModuleName;
					this.<vm>5__7 = this.<>7__wrap12;
					this.<>7__wrap11 = null;
					this.<>7__wrap12 = null;
					LoginViewModel loginViewModel = this.<vm>5__7;
					bool flag5;
					if (!this.<hopexProviderEnabled>5__4)
					{
						flag5 = this.<vm>5__7.VisibleExternalProviders.Count(new Func<ExternalProvider, bool>(ViewModelFactory.<>c.<>9.<BuildLoginViewModelAsync>b__11_1)) == 0;
					}
					else
					{
						flag5 = true;
					}
					loginViewModel.HopexProviderEnabled = flag5;
					this.<vm>5__7.IsExternalLoginOnly = this.<vm>5__7.VisibleExternalProviders.Count<ExternalProvider>() == 1 && !this.<hasNoSsoParam>5__6 && (!this.<vm>5__7.HopexProviderEnabled || !this.<hopexProviderVisible>5__5);
					LoginViewModel loginViewModel2 = this.<vm>5__7;
					string text;
					if (!this.<vm>5__7.IsExternalLoginOnly)
					{
						text = null;
					}
					else
					{
						IEnumerable<ExternalProvider> visibleExternalProviders = this.<vm>5__7.VisibleExternalProviders;
						if (visibleExternalProviders == null)
						{
							text = null;
						}
						else
						{
							ExternalProvider externalProvider = visibleExternalProviders.SingleOrDefault<ExternalProvider>();
							text = ((externalProvider != null) ? externalProvider.AuthenticationScheme : null);
						}
					}
					loginViewModel2.ExternalLoginScheme = text;
					string moduleId = ModuleHelper.GetCurrentModuleId(this.returnUrl);
					if (moduleId == "has.console")
					{
						this.<vm>5__7.ShowBasicSignin = true;
						this.<vm>5__7.IsExternalLoginOnly = false;
					}
					this.<isEnvironmentsRequired>5__8 = viewModelFactory._httpContextAccessor.HttpContext.Request.IsHopexLogin(null) && viewModelFactory._clusterConfiguration.IsInitialized;
					this.<environments>5__9 = null;
					this.<allowLocal>5__10 = true;
					awaiter2 = viewModelFactory._interactionService.GetAuthorizationContextAsync(this.returnUrl).GetAwaiter();
					if (!awaiter2.IsCompleted)
					{
						num = (this.<>1__state = 1);
						this.<>u__2 = awaiter2;
						this.<>t__builder.AwaitUnsafeOnCompleted<TaskAwaiter<AuthorizationRequest>, ViewModelFactory.<BuildLoginViewModelAsync>d__11>(ref awaiter2, ref this);
						return;
					}
					IL_0406:
					AuthorizationRequest result3 = awaiter2.GetResult();
					this.<context>5__11 = result3;
					if (viewModelFactory._clusterConfiguration.IsInitialized)
					{
						goto IL_0427;
					}
					goto IL_0702;
					IL_060F:
					Client result4 = awaiter4.GetResult();
					this.<>8__2.client = result4;
					if (this.<>8__2.client != null)
					{
						this.<allowLocal>5__10 = this.<>8__2.client.EnableLocalLogin;
						if (this.<>8__2.client.IdentityProviderRestrictions != null && this.<>8__2.client.IdentityProviderRestrictions.Any<string>())
						{
							this.<providers>5__3 = this.<providers>5__3.Where(new Func<ExternalProvider, bool>(this.<>8__2.<BuildLoginViewModelAsync>b__6)).ToList<ExternalProvider>();
						}
					}
					this.<>8__2 = null;
					IL_069F:
					ExternalProvider windowsProvider = this.<providers>5__3.FirstOrDefault(new Func<ExternalProvider, bool>(ViewModelFactory.<>c.<>9.<BuildLoginViewModelAsync>b__11_5));
					if (windowsProvider != null)
					{
						WindowsConfig config = windowsProvider.GetConfiguration<WindowsConfig>();
						AccountOptions.IncludeWindowsGroups = true;
						AccountOptions.WindowsGroupsAuthorized = config.WindowsRole;
						AccountOptions.WindowsSourceIdentifier = config.WindowsSourceIdentifier;
						AccountOptions.ClaimForRoles = config.ClaimForRoles;
					}
					IL_0702:
					this.<vm>5__7.IsEnvironmentsRequired = this.<isEnvironmentsRequired>5__8;
					this.<vm>5__7.EnvironmentId = this.<>8__1.environmentId;
					this.<vm>5__7.AllowRememberLogin = AccountOptions.AllowRememberLogin;
					this.<vm>5__7.IsSetupMode = !viewModelFactory._clusterConfiguration.IsInitialized;
					this.<vm>5__7.ReturnUrl = this.returnUrl;
					LoginViewModel loginViewModel3 = this.<vm>5__7;
					IEnumerable<HopexEnvironmentInfo> enumerable = this.<environments>5__9;
					IEnumerable<SelectListItem> enumerable2;
					if (enumerable == null)
					{
						enumerable2 = null;
					}
					else
					{
						enumerable2 = enumerable.Select(new Func<HopexEnvironmentInfo, SelectListItem>(ViewModelFactory.<>c.<>9.<BuildLoginViewModelAsync>b__11_2));
					}
					loginViewModel3.Environments = enumerable2;
					LoginInputModel loginInputModel = this.<vm>5__7;
					AuthorizationRequest authorizationRequest2 = this.<context>5__11;
					loginInputModel.UserName = ((authorizationRequest2 != null) ? authorizationRequest2.LoginHint : null);
					LoginViewModel loginViewModel4 = this.<vm>5__7;
					List<ExternalProvider> list = this.<providers>5__3;
					IEnumerable<ExternalProvider> enumerable3 = ((list != null) ? list.ToArray() : null);
					loginViewModel4.ExternalProviders = enumerable3 ?? Enumerable.Empty<ExternalProvider>();
					this.<vm>5__7.ShowBasicSignin |= this.<allowLocal>5__10 && AccountOptions.AllowLocalLogin && this.<vm>5__7.HopexProviderEnabled && (this.<hopexProviderVisible>5__5 | this.<hasNoSsoParam>5__6);
					valueTuple = new ValueTuple<string, LoginViewModel>(this.<error>5__2, this.<vm>5__7);
				}
				catch (Exception ex3)
				{
					this.<>1__state = -2;
					this.<>8__1 = null;
					this.<error>5__2 = null;
					this.<providers>5__3 = null;
					this.<vm>5__7 = null;
					this.<environments>5__9 = null;
					this.<context>5__11 = null;
					this.<>t__builder.SetException(ex3);
					return;
				}
				this.<>1__state = -2;
				this.<>8__1 = null;
				this.<error>5__2 = null;
				this.<providers>5__3 = null;
				this.<vm>5__7 = null;
				this.<environments>5__9 = null;
				this.<context>5__11 = null;
				this.<>t__builder.SetResult(valueTuple);
			}

			// Token: 0x06000CE7 RID: 3303 RVA: 0x00066B40 File Offset: 0x00064D40
			[DebuggerHidden]
			void IAsyncStateMachine.SetStateMachine([global::System.Runtime.CompilerServices.Nullable(1)] IAsyncStateMachine stateMachine)
			{
				this.<>t__builder.SetStateMachine(stateMachine);
			}

			// Token: 0x04000BC0 RID: 3008
			public int <>1__state;

			// Token: 0x04000BC1 RID: 3009
			public AsyncTaskMethodBuilder<ValueTuple<string, LoginViewModel>> <>t__builder;

			// Token: 0x04000BC2 RID: 3010
			public string environmentId;

			// Token: 0x04000BC3 RID: 3011
			public ViewModelFactory <>4__this;

			// Token: 0x04000BC4 RID: 3012
			public string returnUrl;

			// Token: 0x04000BC5 RID: 3013
			public bool hideModuleName;

			// Token: 0x04000BC6 RID: 3014
			private ViewModelFactory.<>c__DisplayClass11_0 <>8__1;

			// Token: 0x04000BC7 RID: 3015
			private ViewModelFactory.<>c__DisplayClass11_1 <>8__2;

			// Token: 0x04000BC8 RID: 3016
			private string <error>5__2;

			// Token: 0x04000BC9 RID: 3017
			private List<ExternalProvider> <providers>5__3;

			// Token: 0x04000BCA RID: 3018
			private bool <hopexProviderEnabled>5__4;

			// Token: 0x04000BCB RID: 3019
			private bool <hopexProviderVisible>5__5;

			// Token: 0x04000BCC RID: 3020
			private bool <hasNoSsoParam>5__6;

			// Token: 0x04000BCD RID: 3021
			private LoginViewModel <vm>5__7;

			// Token: 0x04000BCE RID: 3022
			private bool <isEnvironmentsRequired>5__8;

			// Token: 0x04000BCF RID: 3023
			private IEnumerable<HopexEnvironmentInfo> <environments>5__9;

			// Token: 0x04000BD0 RID: 3024
			private bool <allowLocal>5__10;

			// Token: 0x04000BD1 RID: 3025
			private AuthorizationRequest <context>5__11;

			// Token: 0x04000BD2 RID: 3026
			private LoginViewModel <>7__wrap11;

			// Token: 0x04000BD3 RID: 3027
			private LoginViewModel <>7__wrap12;

			// Token: 0x04000BD4 RID: 3028
			private TaskAwaiter<string> <>u__1;

			// Token: 0x04000BD5 RID: 3029
			private TaskAwaiter<AuthorizationRequest> <>u__2;

			// Token: 0x04000BD6 RID: 3030
			private TaskAwaiter<IEnumerable<HopexEnvironmentInfo>> <>u__3;

			// Token: 0x04000BD7 RID: 3031
			private TaskAwaiter<Client> <>u__4;
		}

		// Token: 0x0200020B RID: 523
		[CompilerGenerated]
		[StructLayout(LayoutKind.Auto)]
		private struct <BuildLostPasswordViewModel>d__12 : IAsyncStateMachine
		{
			// Token: 0x06000CE8 RID: 3304 RVA: 0x00066B50 File Offset: 0x00064D50
			void IAsyncStateMachine.MoveNext()
			{
				int num = this.<>1__state;
				ViewModelFactory viewModelFactory = this.<>4__this;
				LostPasswordViewModel lostPasswordViewModel;
				try
				{
					TaskAwaiter<IEnumerable<HopexEnvironmentInfo>> awaiter;
					if (num != 0)
					{
						this.<vm>5__2 = new LostPasswordViewModel();
						awaiter = viewModelFactory._hopexSSPClient.GetEnvironments().GetAwaiter();
						if (!awaiter.IsCompleted)
						{
							this.<>1__state = 0;
							this.<>u__1 = awaiter;
							this.<>t__builder.AwaitUnsafeOnCompleted<TaskAwaiter<IEnumerable<HopexEnvironmentInfo>>, ViewModelFactory.<BuildLostPasswordViewModel>d__12>(ref awaiter, ref this);
							return;
						}
					}
					else
					{
						awaiter = this.<>u__1;
						this.<>u__1 = default(TaskAwaiter<IEnumerable<HopexEnvironmentInfo>>);
						this.<>1__state = -1;
					}
					IEnumerable<HopexEnvironmentInfo> result = awaiter.GetResult();
					IEnumerable<HopexEnvironmentInfo> environments = result;
					if (environments == null || environments.Count<HopexEnvironmentInfo>() == 0)
					{
						this.<vm>5__2.Environments = null;
					}
					else
					{
						this.<vm>5__2.Environments = environments.Select(new Func<HopexEnvironmentInfo, SelectListItem>(ViewModelFactory.<>c.<>9.<BuildLostPasswordViewModel>b__12_0));
					}
					lostPasswordViewModel = this.<vm>5__2;
				}
				catch (Exception ex)
				{
					this.<>1__state = -2;
					this.<vm>5__2 = null;
					this.<>t__builder.SetException(ex);
					return;
				}
				this.<>1__state = -2;
				this.<vm>5__2 = null;
				this.<>t__builder.SetResult(lostPasswordViewModel);
			}

			// Token: 0x06000CE9 RID: 3305 RVA: 0x00066C80 File Offset: 0x00064E80
			[DebuggerHidden]
			void IAsyncStateMachine.SetStateMachine([global::System.Runtime.CompilerServices.Nullable(1)] IAsyncStateMachine stateMachine)
			{
				this.<>t__builder.SetStateMachine(stateMachine);
			}

			// Token: 0x04000BD8 RID: 3032
			public int <>1__state;

			// Token: 0x04000BD9 RID: 3033
			public AsyncTaskMethodBuilder<LostPasswordViewModel> <>t__builder;

			// Token: 0x04000BDA RID: 3034
			public ViewModelFactory <>4__this;

			// Token: 0x04000BDB RID: 3035
			private LostPasswordViewModel <vm>5__2;

			// Token: 0x04000BDC RID: 3036
			private TaskAwaiter<IEnumerable<HopexEnvironmentInfo>> <>u__1;
		}

		// Token: 0x0200020C RID: 524
		[CompilerGenerated]
		[StructLayout(LayoutKind.Auto)]
		private struct <BuildMappingViewModelAsync>d__13 : IAsyncStateMachine
		{
			// Token: 0x06000CEA RID: 3306 RVA: 0x00066C90 File Offset: 0x00064E90
			void IAsyncStateMachine.MoveNext()
			{
				int num = this.<>1__state;
				ViewModelFactory viewModelFactory = this.<>4__this;
				MappingViewModel mappingViewModel;
				try
				{
					TaskAwaiter<IEnumerable<HopexEnvironmentInfo>> awaiter;
					TaskAwaiter<string> awaiter2;
					switch (num)
					{
					case 0:
						awaiter = this.<>u__1;
						this.<>u__1 = default(TaskAwaiter<IEnumerable<HopexEnvironmentInfo>>);
						num = (this.<>1__state = -1);
						break;
					case 1:
						awaiter2 = this.<>u__2;
						this.<>u__2 = default(TaskAwaiter<string>);
						num = (this.<>1__state = -1);
						goto IL_038D;
					case 2:
						IL_0415:
						try
						{
							TaskAwaiter<GetPersonGroupsResult> awaiter3;
							if (num != 2)
							{
								awaiter3 = viewModelFactory._hopexSSPClient.GetPersonGroups(new GetPersonGroupsArgs
								{
									EnvironmentId = this.<vm>5__3.EnvironmentId,
									UserName = this.userName,
									Provider = this.provider,
									Db = this.<vm>5__3.RepositoryId,
									Profile = this.<vm>5__3.ProfileId,
									ClaimForRoles = this.claimForRoles
								}, this.claims).GetAwaiter();
								if (!awaiter3.IsCompleted)
								{
									this.<>1__state = 2;
									this.<>u__3 = awaiter3;
									this.<>t__builder.AwaitUnsafeOnCompleted<TaskAwaiter<GetPersonGroupsResult>, ViewModelFactory.<BuildMappingViewModelAsync>d__13>(ref awaiter3, ref this);
									return;
								}
							}
							else
							{
								awaiter3 = this.<>u__3;
								this.<>u__3 = default(TaskAwaiter<GetPersonGroupsResult>);
								this.<>1__state = -1;
							}
							GetPersonGroupsResult result = awaiter3.GetResult();
							this.<personGroupsResult>5__2 = result;
						}
						catch (Exception)
						{
							this.<vm>5__3.ErrorMessage = "Login is not possible.<br/>Please contact your HOPEX administrator to check logs.";
						}
						this.<vm>5__3.PersonGroups = this.<personGroupsResult>5__2;
						viewModelFactory._logger.LogInformation("Claims and Roles From Provider [ " + this.claims.SerializeToString() + " ]", Array.Empty<object>());
						if (viewModelFactory._httpContextAccessor.HttpContext.Request.Path.HasValue && viewModelFactory._httpContextAccessor.HttpContext.Request.Path.Value.Contains("MappingSubmit"))
						{
							throw new NoProfileException(string.Format(viewModelFactory.S["No profile is configured for the user {0}. Please contact your administrator."], this.<vm>5__3.UserName));
						}
						mappingViewModel = this.<vm>5__3;
						goto IL_05E1;
					default:
					{
						this.<personGroupsResult>5__2 = null;
						NameValueCollection returnUrlParameters = HttpUtility.ParseQueryString(HttpUtility.UrlDecode(this.returnUrl));
						this.<>7__wrap5 = new MappingViewModel();
						this.<>7__wrap5.PersonGroups = this.<personGroupsResult>5__2;
						this.<>7__wrap5.EnvironmentId = this.environmentId;
						this.<>7__wrap5.ReturnUrl = this.returnUrl;
						this.<>7__wrap5.UserName = this.userName;
						MappingInputViewModel mappingInputViewModel = this.<>7__wrap5;
						string text;
						if ((text = returnUrlParameters.Get("Db")) == null)
						{
							Claim claim = this.claims.FirstOrDefault(new Func<Claim, bool>(ViewModelFactory.<>c.<>9.<BuildMappingViewModelAsync>b__13_0));
							text = ((claim != null) ? claim.Value : null);
						}
						mappingInputViewModel.RepositoryId = text;
						MappingInputViewModel mappingInputViewModel2 = this.<>7__wrap5;
						string text2;
						if ((text2 = returnUrlParameters.Get("Profile")) == null)
						{
							Claim claim2 = this.claims.FirstOrDefault(new Func<Claim, bool>(ViewModelFactory.<>c.<>9.<BuildMappingViewModelAsync>b__13_1));
							text2 = ((claim2 != null) ? claim2.Value : null);
						}
						mappingInputViewModel2.ProfileId = text2;
						MappingInputViewModel mappingInputViewModel3 = this.<>7__wrap5;
						Claim claim3 = this.claims.FirstOrDefault(new Func<Claim, bool>(ViewModelFactory.<>c.<>9.<BuildMappingViewModelAsync>b__13_2));
						mappingInputViewModel3.UserId = ((claim3 != null) ? claim3.Value : null);
						MappingInputViewModel mappingInputViewModel4 = this.<>7__wrap5;
						Claim claim4 = this.claims.FirstOrDefault(new Func<Claim, bool>(ViewModelFactory.<>c.<>9.<BuildMappingViewModelAsync>b__13_3));
						mappingInputViewModel4.AssignableElementId = ((claim4 != null) ? claim4.Value : null);
						MappingInputViewModel mappingInputViewModel5 = this.<>7__wrap5;
						Claim claim5 = this.claims.FirstOrDefault(new Func<Claim, bool>(ViewModelFactory.<>c.<>9.<BuildMappingViewModelAsync>b__13_4));
						mappingInputViewModel5.DataLanguageId = ((claim5 != null) ? claim5.Value : null);
						MappingInputViewModel mappingInputViewModel6 = this.<>7__wrap5;
						Claim claim6 = this.claims.FirstOrDefault(new Func<Claim, bool>(ViewModelFactory.<>c.<>9.<BuildMappingViewModelAsync>b__13_5));
						mappingInputViewModel6.GuiLanguageId = ((claim6 != null) ? claim6.Value : null);
						MappingInputViewModel mappingInputViewModel7 = this.<>7__wrap5;
						Claim claim7 = this.claims.FirstOrDefault(new Func<Claim, bool>(ViewModelFactory.<>c.<>9.<BuildMappingViewModelAsync>b__13_6));
						mappingInputViewModel7.Login = ((claim7 != null) ? claim7.Value : null);
						this.<>7__wrap5.Provider = this.provider;
						this.<>7__wrap3 = this.<>7__wrap5;
						awaiter = viewModelFactory._hopexSSPClient.GetEnvironments().GetAwaiter();
						if (!awaiter.IsCompleted)
						{
							this.<>1__state = 0;
							this.<>u__1 = awaiter;
							this.<>t__builder.AwaitUnsafeOnCompleted<TaskAwaiter<IEnumerable<HopexEnvironmentInfo>>, ViewModelFactory.<BuildMappingViewModelAsync>d__13>(ref awaiter, ref this);
							return;
						}
						break;
					}
					}
					IEnumerable<HopexEnvironmentInfo> result2 = awaiter.GetResult();
					this.<>7__wrap3.Environments = result2.Select(new Func<HopexEnvironmentInfo, SelectListItem>(ViewModelFactory.<>c.<>9.<BuildMappingViewModelAsync>b__13_7));
					this.<>7__wrap4 = this.<>7__wrap5;
					awaiter2 = ModuleHelper.GetModuleFriendlyName(viewModelFactory._clusterAdminClient, this.returnUrl).GetAwaiter();
					if (!awaiter2.IsCompleted)
					{
						this.<>1__state = 1;
						this.<>u__2 = awaiter2;
						this.<>t__builder.AwaitUnsafeOnCompleted<TaskAwaiter<string>, ViewModelFactory.<BuildMappingViewModelAsync>d__13>(ref awaiter2, ref this);
						return;
					}
					IL_038D:
					string result3 = awaiter2.GetResult();
					this.<>7__wrap4.ModuleFriendlyName = result3;
					this.<>7__wrap5.ClaimForRoles = this.claimForRoles;
					this.<vm>5__3 = this.<>7__wrap5;
					this.<>7__wrap3 = null;
					this.<>7__wrap4 = null;
					this.<>7__wrap5 = null;
					if (this.<vm>5__3.EnvironmentId == null && this.<vm>5__3.Environments.Count<SelectListItem>() == 1)
					{
						this.<vm>5__3.EnvironmentId = this.<vm>5__3.Environments.First<SelectListItem>().Value;
						goto IL_0415;
					}
					goto IL_0415;
				}
				catch (Exception ex)
				{
					this.<>1__state = -2;
					this.<personGroupsResult>5__2 = null;
					this.<vm>5__3 = null;
					this.<>t__builder.SetException(ex);
					return;
				}
				IL_05E1:
				this.<>1__state = -2;
				this.<personGroupsResult>5__2 = null;
				this.<vm>5__3 = null;
				this.<>t__builder.SetResult(mappingViewModel);
			}

			// Token: 0x06000CEB RID: 3307 RVA: 0x000672D4 File Offset: 0x000654D4
			[DebuggerHidden]
			void IAsyncStateMachine.SetStateMachine([global::System.Runtime.CompilerServices.Nullable(1)] IAsyncStateMachine stateMachine)
			{
				this.<>t__builder.SetStateMachine(stateMachine);
			}

			// Token: 0x04000BDD RID: 3037
			public int <>1__state;

			// Token: 0x04000BDE RID: 3038
			public AsyncTaskMethodBuilder<MappingViewModel> <>t__builder;

			// Token: 0x04000BDF RID: 3039
			public string returnUrl;

			// Token: 0x04000BE0 RID: 3040
			public string environmentId;

			// Token: 0x04000BE1 RID: 3041
			public string userName;

			// Token: 0x04000BE2 RID: 3042
			public IEnumerable<Claim> claims;

			// Token: 0x04000BE3 RID: 3043
			public string provider;

			// Token: 0x04000BE4 RID: 3044
			public ViewModelFactory <>4__this;

			// Token: 0x04000BE5 RID: 3045
			public string claimForRoles;

			// Token: 0x04000BE6 RID: 3046
			private GetPersonGroupsResult <personGroupsResult>5__2;

			// Token: 0x04000BE7 RID: 3047
			private MappingViewModel <vm>5__3;

			// Token: 0x04000BE8 RID: 3048
			private MappingViewModel <>7__wrap3;

			// Token: 0x04000BE9 RID: 3049
			private MappingViewModel <>7__wrap4;

			// Token: 0x04000BEA RID: 3050
			private MappingViewModel <>7__wrap5;

			// Token: 0x04000BEB RID: 3051
			private TaskAwaiter<IEnumerable<HopexEnvironmentInfo>> <>u__1;

			// Token: 0x04000BEC RID: 3052
			private TaskAwaiter<string> <>u__2;

			// Token: 0x04000BED RID: 3053
			private TaskAwaiter<GetPersonGroupsResult> <>u__3;
		}
	}
}
